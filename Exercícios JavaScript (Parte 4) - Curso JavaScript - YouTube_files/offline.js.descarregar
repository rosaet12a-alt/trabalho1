(function(g){var window=this;'use strict';var Bbh=function(m){const V=new g.fu("und",new g.I6("Default","und",!0));V.captionTracks=m.captionTracks;return V},llc=function(m){return new g.Zn(function(V,O){let h=m.length;
const w=[];if(h){var y=function(C,E){h--;w[C]=E;h==0&&V(w)},L=function(C){O(C)};
for(let C=0;C<m.length;C++){var J=m[C];g.lL(J,g.yW(y,C),L)}}else V(w)})},Qrh=function({type:m,
payload:V}){m={type:m};V!==void 0&&(m.payload=V);return m},Uq=function(m){m=m.key||m.id;
if(!m)throw Error("Entity key is missing");return m},vic=function(){if(dx)return dx();
dx=g.EZ("PersistentEntityStoreDb",{lz:{EntityStore:{tN:1},EntityAssociationStore:{tN:2}},shared:!1,upgrade(m,V){V(1)&&g.Bs(g.aH(m,"EntityStore",{keyPath:"key"}),"entityType","entityType");V(2)&&(m=g.aH(m,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.Bs(m,"byParentEntityKey","parentEntityKey"),g.Bs(m,"byChildEntityKey","childEntityKey"))},version:3});return dx()},Pwz=function(m){return g.VZ(vic(),m)},td=function(m){return g.VZ((0,g.ONG)(),m)},mYJ=function(m){return m instanceof
Error?new KW("UNKNOWN_ENCODE_ERROR",{originalMessage:m.message}):new KW("UNKNOWN_ENCODE_ERROR")},VtA=function(m){return m instanceof Error?new KW("UNKNOWN_DECODE_ERROR",{originalMessage:m.message}):new KW("UNKNOWN_DECODE_ERROR")},Ok$=function(m,V){m=m instanceof KW?m:V(m);
g.a(m);throw m;},hwJ=function(m,V,O){try{return m.L(V,O)}catch(h){Ok$(h,mYJ)}},W$=function(m){m=(new TextEncoder).encode(m).subarray(0,16);
const V=new Uint8Array(16);V.set(m);return V},y95=function(m){const V=wNI[m];
if(V)return V;g.kW(new g.Xa("Entity model not found.",{entityType:m}))},H$=function(m,V){a:{m=X5(m.A,V.version);
try{var O=m.A(V.data,V.key);break a}catch(h){Ok$(h,VtA)}O=void 0}return O},T1=function(m,V,O){return m.Z.objectStore("EntityStore").get(V).then(h=>{if(h){if(O&&h.entityType!==O)throw Error("Incorrect entity type");
return H$(m,h)}})},$g=function(m,V,O){return O?(O=O.map(h=>T1(m,h,V)),g.IH.all(O)):m.Z.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(V)).then(h=>h.map(w=>H$(m,w)))},LpW=function(m,V,O){const h=Uq(V);
return Yg(m,h).then(()=>jQZ(m,V,O))},kg=function(m,V,O){let h=m.L[O];
h||(h=new Set,m.L[O]=h);h.add(V)},rx=function(m,V,O){const h=Uq(V),w=X5(m.A,1),y={...V};
return m.Z.objectStore("EntityStore").get(h).then(L=>{if(L){if(L.entityType!==O)throw Error("Incorrect entity type");y.entityMetadata||(L=H$(m,L),y.entityMetadata=L.entityMetadata)}}).then(()=>{const L={key:h,
entityType:O,data:hwJ(w,y,h),version:1};return g.IH.all([g.GF(m.Z.objectStore("EntityStore"),L),LpW(m,y,O)])}).then(()=>{kg(m,h,O);
return h})},c$=function(m,V,O){V=V.map(h=>rx(m,h,O));
return g.IH.all(V)},C5c=function(m,V,O){if(O.has(V))return g.IH.resolve(void 0);
O.add(V);return J9Z(m,V).then(h=>m.Z.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(V)).then(()=>h)).then(h=>{let w=g.IH.resolve(void 0);
for(const y of h)w=w.then(()=>C5c(m,y,O));
return w}).then(()=>{})},DK=function(m,V,O){if(O?.NH){const w=new Set;
return C5c(m,V,w).then(()=>{const y=[];for(const L of w)y.push(DK(m,L));return g.IH.all(y).then(()=>{})})}const h=g.GQ(V).entityType;
return g.IH.all([m.Z.objectStore("EntityStore").delete(V),Yg(m,V)]).then(()=>{kg(m,V,h)})},Yg=function(m,V){return m.Z.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(V))},NV=function(m,V){return g.Ps(m.Z.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(V)},O=>g.IH.all([O.delete(),
Yg(m,O.cursor.primaryKey)]).then(()=>{kg(m,O.cursor.primaryKey,V);return g.vs(O)}))},EXh=function(m,V,O,h){const w=X5(m.A,1);
return T1(m,V,h).then(y=>{if(y){y=g.EG(y,O);var L={key:V,entityType:h,data:hwJ(w,y,V),version:1};return g.IH.all([g.GF(m.Z.objectStore("EntityStore"),L),LpW(m,y,h)])}}).then(()=>{kg(m,V,h);
return V})},jQZ=function(m,V,O){const h=Uq(V);
O=y95(O);if(!O)return g.IH.resolve([]);V=new O(V);m=m.Z.objectStore("EntityAssociationStore");O=[];for(const w of V.A())O.push(g.GF(m,{parentEntityKey:h,childEntityKey:w}));return g.IH.all(O).then(w=>w.map(y=>y[1]))},J9Z=function(m,V){const O=m.Z.objectStore("EntityAssociationStore");
return O.index("byParentEntityKey").getAll(IDBKeyRange.only(V)).then(h=>{const w=[];for(const y of h)w.push(O.index("byChildEntityKey").getAll(y.childEntityKey));return g.IH.all(w)}).then(h=>{const w=[];
for(const y of h)y.length===1&&w.push(y[0].childEntityKey);return w})},X5=function(m,V=0){m=m.Z[V];
if(!m)throw V=new KW("INVALID_ENCODER_VERSION",{Bb:V}),g.a(V),V;return m},qVH=function(m,V){for(const O of m.observers)O(V)},b$=async function(m,V,O){var h=await Pwz(m.token);
let w;V=await g.Fk(h,["EntityStore","EntityAssociationStore"],V,y=>{w=new MtM(y,m.Z);return O(w)});
w&&(h=w.L,Object.keys(h).length>0&&(m.channel.postMessage(h),qVH(m,h)));return V},nW=function(m,V,O){return b$(m,{mode:"readwrite",
tj:!0},h=>rx(h,V,O))},fc5=function(m,V){return b$(m,{mode:"readwrite",
tj:!0},O=>c$(O,V,"offlineOrchestrationActionWrapperEntity"))},SA=function(m,V){return b$(m,{mode:"readwrite",
tj:!0},O=>DK(O,V))},xYZ=function(m){return b$(m,{mode:"readwrite",
tj:!0},V=>NV(V,"videoPlaybackPositionEntity"))},I9=function(m,V,O){return b$(m,{mode:"readonly",
tj:!0},h=>T1(h,V,O))},eA=function(m,V,O){return b$(m,{mode:"readonly",
tj:!0},h=>$g(h,V,O))},gX$=async function(){try{const V=await g.CD();
if(V&&g.RH()&&typeof g.aC.BroadcastChannel!=="undefined"){var m=new RwA;return new oXh(V,m)}}catch(V){V instanceof Error&&g.a(V)}},z1=function(){u$||(u$=gX$());
return u$},A9a=function(m){m=m.options?.persistenceOption;
return m==="ENTITY_PERSISTENCE_OPTION_PERSIST"||m==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},UYh=async function(m){const V=await z1();
V&&await b$(V,"readwrite",O=>{const h={};for(const w of m){if(!w.entityKey||!A9a(w))continue;const y=g.lz(w.payload);let L=void 0;w.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(L=()=>rx(O,w.payload[y],y));
w.type==="ENTITY_MUTATION_TYPE_DELETE"&&(L=()=>DK(O,w.entityKey));
w.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(L=()=>EXh(O,w.entityKey,w.payload[y],y));
L&&(h[w.entityKey]=h[w.entityKey]?h[w.entityKey].then(L):L())}return g.IH.all(Object.values(h))})},ZK=async function(m){!(m=m.mutations)||m.length<=0||(g.QA&&g.QA.dispatch(Qrh({type:"ENTITY_LOADED",
payload:m})),await UYh(m),m.length=0)},dYn=function(m){return m!==void 0},ttJ=function(m){var V=g.ri();
V=Object.assign({},V);m=Object.assign({},m);for(const O in V)m[O]?(V[O]!==4&&(V[O]=m[O]),delete m[O]):V[O]!==2&&(V[O]=4);Object.assign(V,m);g.iqo(V);JSON.stringify(V);return V},KpG=async function(m){const V=await g.CD();
return V?g.Fk(await g.NT(V),["index","media","captions"],{mode:"readwrite",tj:!0},O=>{const h=IDBKeyRange.bound(m+"|",m+"~");O=[O.objectStore("index").delete(h),O.objectStore("media").delete(h),O.objectStore("captions").delete(h)];return g.IH.all(O).then(()=>{})}):void 0},Wpz=async function(){const m=await g.CD();
if(!m)throw g.S8("rvdfd");return g.Fk(await g.NT(m),["index","media"],{mode:"readwrite",tj:!0},V=>{const O={};return g.Q4(V.objectStore("index"),{},h=>{var w=h.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let y=g.IH.resolve(void 0);if(w){const L=w[1];w=w[2];O[L]=O[L]||{};O[L][w]=g.lrU(h.getValue()?.fmts)}else y=h.delete().then(()=>{});
return g.IH.all([g.vs(h),y]).then(([L])=>L)}).then(()=>{const h={};
for(const y of Object.keys(O)){const L=O[y].v;h[y]=O[y].a&&L?1:2}const w=ttJ(h);return g.ssC(V.objectStore("media"),{},y=>{const L=y.cursor.key.match(g.mzl);L&&h[L[1]]||V.objectStore("media").delete(y.cursor.key);return g.b4o(y)}).then(()=>w)})})},XNG=async function(m,V){var O=await g.CD();
if(!O)throw g.S8("wct");O=await g.NT(O);await g.Fk(O,["captions"],{mode:"readwrite",tj:!0},h=>{const w=[];h=h.objectStore("captions");for(let y=0;y<V.length;y++){const L=g.GF(h,V[y],m+"|"+V[y].metadata.vss_id);w.push(L)}return g.IH.all(w)})},HkA=async function(m){m=IDBKeyRange.bound(m+"|",m+"~");
const V=await g.CD();if(!V)throw g.S8("gactfv");return(await g.NT(V)).getAll("captions",m)},TVh=async function(m){g.DW(m,0);
return KpG(m)},$YW=function(m){return{context:g.wH(),
videoIds:m}},YVa=function(m){return{context:g.wH(),
playlistIds:m}},koc=function(m){return{context:g.wH(),
offlinePlaylistSyncChecks:m}},c9n=function(){sq||(sq=new r9a);
return sq},DYc=function(m,V){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:m},metadata:V,statusCode:void 0,csn:void 0,can:void 0}},NVM=function(m,V,O){O||(O=m.Z.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),O||(O=g.Rl(16),m.Z.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",O)));
m={flowNonce:O,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:V.eventType};V.metadata&&(m.flowMetadata=V.metadata);V.statusCode!==void 0&&(m.flowEventStatus=V.statusCode);V.csn&&(m.csn=V.csn);V.can&&(m.can=V.can);g.xW("flowEvent",m,void 0)},bkG=async function(m){var V=await b$(m,{mode:"readonly",
tj:!0},x=>$g(x,"playbackData").then(U=>{var H=U.map(n=>n.transfer).filter(n=>!!n),k=U.map(n=>n.offlineVideoPolicy).filter(n=>!!n),b=U.filter(n=>!!n.key).map(n=>g.pq(g.GQ(n.key).entityId,"downloadStatusEntity"));
H=$g(x,"transfer",H);k=$g(x,"offlineVideoPolicy",k);b=$g(x,"downloadStatusEntity",b);const c=H.then(n=>{n=n.reduce((z,w7)=>{w7?.offlineVideoStreams&&z.push(...w7.offlineVideoStreams);return z},[]).filter(z=>!!z);
return $g(x,"offlineVideoStreams",n)});
return g.IH.all([H,k,c,b]).then(([n,z,w7,JI])=>[U,n,z,w7,JI])}));
m=await b$(m,{mode:"readonly",tj:!0},x=>$g(x,"mainDownloadsListEntity").then(U=>U[0]?.downloads??[]));
const [O,h,w,y,L]=V,J={},C={},E={},q={},M={};V=[];for(var f of h)f&&(J[f.key]=f);for(const x of w)x&&(C[x.key]=x);for(const x of L)x&&(E[x.key]=x);for(const x of y)x&&(q[x.key]=x);for(const x of m)M[x.videoItem??""]=!0,x.videoItem&&(f=g.GQ(x.videoItem)?.entityId??"",V.push({externalVideoId:f}));return{offlineVideos:O.filter(x=>{if(!x||!x.key||!x.offlineVideoPolicy)return!1;x=g.GQ(x.key).entityId;x=g.pq(x,"downloadStatusEntity");return!(x&&E[x]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(x=>
{var U=J[x.transfer];
const H=[];if(U?.offlineVideoStreams)for(var k of U.offlineVideoStreams){var b=q[k];b&&H.push(b)}k=C[x.offlineVideoPolicy];b=x?.playerResponseTimestamp;var c=g.GQ(k.key).entityId;x=g.pq(c,"mainVideoEntity");if(k.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var n="OFFLINE_VIDEO_STATE_DISABLED";k.expirationTimestamp&&Number(k.expirationTimestamp)<Date.now()/1E3&&(n="OFFLINE_VIDEO_STATE_EXPIRED")}else if(k.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")n="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(U?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":n="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":n="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":n="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":n="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":n="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":n="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:n="OFFLINE_VIDEO_STATE_UNKNOWN"}if(n==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(U?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":n="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":n="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":n="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}c={id:c,videoState:n};
U?.cotn&&(c.cotn=U.cotn);U?.maximumDownloadQuality&&(c.selectedVideoQuality=U?.maximumDownloadQuality);U?.lastProgressTimeMs&&(c.lastProgressTimeMs=U.lastProgressTimeMs);b&&(c.playerResponseSavedTimeMs=String(Number(b)*1E3));U=String;b=0;for(const z of H)if(z.streamsProgress)for(const w7 of z.streamsProgress)b+=Number(w7.numBytesDownloaded??0);c.downloadedBytes=U(b);c.selectedOfflineMode=M[x]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";k.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(c.offlinePlaybackDisabledReason=
k.offlinePlaybackDisabledReason);return c}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:V}}}},SVM=function(){try{let O=g.Gl("ytglobal.locks_");
if(O)return O;var m;if(m=navigator){var V=navigator;m="locks"in V&&!!V.locks}if(m)return g.aC.localStorage&&g.aC.localStorage.getItem("noop"),O=new nXA,g.ip("ytglobal.locks_",O),O}catch{}},F5=function(m){if(m.includes(":"))throw Error(`Invalid user cache name: ${m}`);
return`${m}:${g.x7("CacheStorage get")}`},IcG=async function(){return a9!==void 0?a9:a9=new Promise(async m=>{try{await i$.open("test-only"),await i$.delete("test-only")}catch(V){if(V instanceof Error&&V.name==="SecurityError"){m(!1);
return}}m("caches"in window)})},pW=async function(){if(await IcG())return G1||(G1=new ew5),G1},B$=function(m,V,O){g.kW(new g.Xa(`Woffle: ${m}`,O?{cotn:O}:""));
V instanceof Error&&g.kW(V)},uYz=async function(m){m=await bkG(m);
g.xW("offlineStateSnapshot",m)},l$=function(m,V){g.Zj(m.api,"onOfflineOperationFailure",V);
m.Z?.postMessage(V)},zwn=function(m){if(!m.L&&!m.Z){var V=SVM();
if(V){m.L=!0;var O=g.x7("OfflineLockManager");V.request(`${"woffle_orchestration_leader"}:${O}`,{},async()=>{try{m.A=new g.xN,m.Z=!0,m.L=!1,await m.X(),await m.A.promise}catch(h){m.Ws(),h instanceof Error&&(h.args=[{name:"WoLockManagerError",D5:h.name}],g.a(h))}})}}},Qr=function(m){m.N&&m.U&&m.T&&m.visibility.isBackground()?m.D.sI(6E4):m.D.stop()},ZkZ=function(m){m.Z&&(m.T=!0,Qr(m))},sQn=function(m,V){m.Z&&(m.U=V,Qr(m))},Fph=function(m,V){m.Z&&(m.N=V,Qr(m))},v$=function(m){m.offlineDeleteReason=m.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
m.offlineModeType=m.offlineModeType??"OFFLINE_NOW";g.xW("offlineDeleteEvent",m)},P$=function(m,{videoId:V,
Os:O,offlineModeType:h}){m.encryptedVideoId=V;m.cotn=O?.cotn;m.offlineabilityFormatType=O?.maximumDownloadQuality;m.isRefresh=O?.isRefresh??!1;m.softErrorCount=O?.transferRetryCount??0;m.offlineModeType=h??"OFFLINE_NOW";(m.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&m.statusType==="UNKNOWN_STATUS_TYPE"||!m.transferStatusType&&!m.statusType)&&g.kW(Error("Woffle unknown transfer status"));g.xW("offlineTransferStatusChanged",m)},acA=function(m,V,O,h){h={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!h};V&&O&&(V=Math.floor(V/1024).toFixed(),O=Math.floor(O/1024).toFixed(),h.alreadyDownloadedKbytes=V,h.totalFetchedKbytes=V,h.totalContentKbytes=O);P$(h,m)},ikH=function(m){P$({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},m)},Gon=function(m){switch(m){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
my=function(m){return(m.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},VD=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!m.entityKey},OT=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!m.entityKey},ho=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!m.entityKey},pN5=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!m.entityKey},wE=async function(m,V,O,h,w=!1){const y=
g.pq(m,V),L=g.pq(m,"downloadStatusEntity");
m=await b$(O,{mode:"readonly",tj:!0},C=>g.IH.all([T1(C,y,V),T1(C,L,"downloadStatusEntity")]));
const J=m.length?m[0]:void 0;if(J){let C=m.length>1?m[1]:void 0;if(C){if(C.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!w)return;C.downloadState=h}else C={key:L,downloadState:h};g.bE(J,BV$,C);await b$(O,{mode:"readwrite",tj:!0},E=>g.IH.all([rx(E,J,V),rx(E,C,"downloadStatusEntity")]))}},yD=function(m,V){return m.actionType===V.actionType&&m.entityKey===V.entityKey},jI=function(m,V){if(m&&m.transferState!=="TRANSFER_STATE_COMPLETE"&&m.transferState!=="TRANSFER_STATE_FAILED"){const O=g.GQ(m.key).entityId;
P$({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:O,Os:m,offlineModeType:V})}},LV=function(m){if(!m||!m.thumbnails)return[];
const V=[];for(const O of m.thumbnails)O.url&&V.push(O.url);return V},Jo=async function(m,V,O=[]){if(!O.length)return[];
V=await eA(m,V);m=new Set;for(var h of V)if(V=h.id||h.key)V=g.GQ(V).entityId,m.add(V);h=[];for(const w of O)O=w.offlineVideoData,O?.videoId&&!m.has(O.videoId)&&h.push(w);return h},CV=function(m,V,O){return new g.EC(m,{cotn:V,
raw_player_response:O,download_media:!0,start:Infinity,disable_watch_next:!0})},ET=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},Mk=function(m){if(!m.key)throw Error("Entity key is required.");
if(!m.actionProto)throw Error("OfflineOrchestrationAction is required.");const V=g.GQ(m.key),O=g.GQ(m.actionProto.entityKey);return new qk(O.entityType,V.entityId,m.actionProto,m.parentActionId,m.rootActionId,m.childActionIds,m.prereqActionId,m.postreqActionIds,m.retryScheduleIndex,m.hasChildActionFailed,Number(m.enqueueTimeSec)*1E3)},fV=function(m){return{key:g.pq(m.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:m.action,parentActionId:m.parentActionId,rootActionId:m.rootActionId,childActionIds:m.childActionIds,prereqActionId:m.prereqActionId,postreqActionIds:m.postreqActionIds,retryScheduleIndex:m.retryScheduleIndex,hasChildActionFailed:m.hasChildActionFailed,enqueueTimeSec:(m.Z/1E3).toFixed()}},lcc=async function(){const m=await pW();
return m?m.delete("yt-player-local-img"):!0},x2=async function(m){const V=await pW();
if(!V)throw Error("Cache API not supported");if(m.length){var O=await V.open("yt-player-local-img");await Promise.all(m.map(h=>O.delete(h)))}},R7=async function(m){const V=await pW();
if(!V)throw Error("Cache API not supported");m.length&&await (await V.open("yt-player-local-img")).addAll(m)},o7=async function(m,V,O,h,w){const y=g.pq(m,"mainVideoEntity"),L=g.pq(m,"ytMainChannelEntity"),J=g.pq(m,"transfer"),C=g.pq(m,"videoDownloadContextEntity");
var E=await b$(V,{mode:"readonly",tj:!0},n=>g.IH.all([T1(n,y,"mainVideoEntity"),T1(n,L,"ytMainChannelEntity"),T1(n,J,"transfer"),T1(n,C,"videoDownloadContextEntity"),$g(n,"ytMainChannelEntity"),$g(n,"offlineOrchestrationActionWrapperEntity")]));
const [q,M,f,x,U,H]=E;if(q||M){E=q?LV(q.thumbnail):[];var k=M?await QQG(M,U):[];await x2(E.concat(k))}const b=[],c=g.pq(m,"downloadStatusEntity");for(const n of H)E=g.GQ(n.key).entityId,k=Mk(n),k=g.GQ(k.action.entityKey).entityId,E!==m&&k!==m||yD(O,n.actionProto)||b.push(n.key);await b$(V,{mode:"readwrite",tj:!0},n=>{const z=b.map(w7=>DK(n,w7));
z.push(DK(n,y,{NH:!0}));z.push(DK(n,c,{NH:!0}));return g.IH.all(z)});
m=x?.offlineModeType;w&&(v$(w),w.offlineModeType&&(m=w.offlineModeType));jI(f,m);l$(h,{entityKey:y,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},gE=async function(m,V,O,h){const w=g.pq(m,"mainPlaylistEntity"),y=g.pq(m,"ytMainChannelEntity");
var L=await b$(V,{mode:"readonly",tj:!0},n=>g.IH.all([T1(n,w,"mainPlaylistEntity"),T1(n,y,"ytMainChannelEntity"),$g(n,"mainPlaylistEntity"),$g(n,"mainDownloadsListEntity"),$g(n,"ytMainChannelEntity"),$g(n,"offlineOrchestrationActionWrapperEntity")]));
const [J,C,E,q,M,f]=L;if(J||C){L=J?vXW(J):[];var x=C?await QQG(C,M):[];await x2(L.concat(x))}L=[];x=new Map;if(J){L=await P5z(J,E,q);for(var U of L)x.set(U,{videoId:U,playlistId:m,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});U=await b$(V,{mode:"readonly",tj:!0},w7=>g.IH.all([$g(w7,"transfer"),$g(w7,"videoDownloadContextEntity")]));
const [n,z]=U;for(var H of n)U=g.GQ(H.key).entityId,(U=x.get(U))&&H&&(U.cotn=H.cotn);for(var k of z)H=g.GQ(k.key).entityId,(H=x.get(H))&&k&&(H.offlineModeType=k.offlineModeType)}const b=[];for(const n of f)k=g.GQ(n.key).entityId,H=Mk(n),k!==m&&H.rootActionId!==m||yD(O,n.actionProto)||b.push(n.key);const c=g.pq(m,"mainPlaylistEntity");await b$(V,{mode:"readwrite",tj:!0},n=>{const z=b.map(w7=>DK(n,w7));
z.push(DK(n,c,{NH:!0}));return g.IH.all(z)});
if(J&&(L.reverse(),L))for(const n of L)await o7(n,V,O,h,x.get(n))},Ao=async function(m,V,O,h){const w=g.pq("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),y=new Map;
m=await b$(m,{mode:"readwrite",tj:!0},L=>{const J=$g(L,"transfer"),C=$g(L,"offlineOrchestrationActionWrapperEntity"),E=$g(L,"videoDownloadContextEntity"),q=T1(L,w,"mainDownloadsListEntity");return g.IH.all([J,C,E,q]).then(([M,f,x,U])=>{const H=mcc.map(k=>NV(L,k));
for(const k of f)yD(V,k.actionProto)||H.push(DK(L,k.key,{NH:!0}));U&&(U.downloads=[],H.push(rx(L,U,"mainDownloadsListEntity")));if(x)for(const k of x)f=g.GQ(k.key).entityId,f=g.pq(f,"transfer"),y.set(f,k.offlineModeType);return g.IH.all(H).then(()=>M)})});
for(const L of m){jI(L,y.get(L.key));m=g.GQ(L.key).entityId;const J={videoId:m,offlineDeleteReason:h,cotn:L.cotn,offlineModeType:y.get(L.key)};v$(J);m=g.pq(m,"mainVideoEntity");l$(O,{entityKey:m,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await lcc()},vXW=function(m,V){let O=[];
if(m.thumbnailStyleData)for(const h of m.thumbnailStyleData)O=O.concat(LV(h?.value?.collageThumbnail?.coverThumbnail));m=LV(V);return O.concat(m)},P5z=async function(m,V,O){const h=[],w=new Set;
if(O.length)for(var y of O)if(y.downloads?.length)for(const L of y.downloads)L.videoItem&&(O=g.GQ(L.videoItem).entityId,w.add(O));if(m.videos){for(const L of m.videos)y=JSON.parse(g.GQ(L).entityId),y.videoId&&!w.has(y.videoId)&&h.push(y.videoId);for(const L of V)if(L.key!==m.key&&(V=L.videos))for(const J of V)V=JSON.parse(g.GQ(J).entityId),V.videoId&&(V=h.indexOf(V.videoId),V!==-1&&h.splice(V,1))}return h},QQG=async function(m,V){const O=LV(m.avatar);
for(const h of V)if(h.id!==m.id)for(const w of LV(h.avatar))V=O.indexOf(w),V!==-1&&O.splice(V,1);return O},Vqn=async function(m){const V=g.T(m.frameworkUpdates,UT);
m.frameworkUpdates&&V&&await ZK(V)},h6z=function(m){if(m.onResponseReceivedActions?.length&&(m=g.T(g.T(m.onResponseReceivedActions[0],O4A),g.ayX)?.actions,m?.length))return m},wS$=async function(m){if(!m)return[];
m=await I9(m,g.sH,"mainDownloadsListEntity");return m?.downloads?.length?m.downloads.map(V=>V.videoItem??""):[]},dE=async function(m,V){const O=await yUZ(m,V);
O&&await b$(m,{mode:"readwrite",tj:!0},h=>{const w=[rx(h,O.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];O.mainDownloadsListEntity&&w.push(rx(h,O.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.IH.all(w)})},yUZ=async function(m,V){const O=g.pq("main_downloads_library_id","mainDownloadsLibraryEntity"),h=g.pq("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
m=await b$(m,{mode:"readonly",tj:!0},C=>g.IH.all([T1(C,O,"mainDownloadsLibraryEntity"),T1(C,h,"mainDownloadsListEntity")]));
let [w,y]=m;m=w;let L=y;m||(m={id:O});for(const C of V)if(C===g.sH){if(m.smartDownloadsList)return;m.smartDownloadsList=C}else{var J=g.GQ(C).entityType;V={};J==="mainPlaylistEntity"?V.playlistItem=C:J==="mainVideoEntity"&&(V.videoItem=C);if(!g.yg(V)){if(L?.downloads){J=!1;for(const E of L.downloads)if(E.playlistItem===C||E.videoItem===C){J=!0;break}J||L.downloads.push(V)}else L={id:h,downloads:[V]};m.downloadsList=h}}return{mainDownloadsLibraryEntity:m,mainDownloadsListEntity:L}},to=async function(m,
V){const O=g.pq("main_downloads_library_id","mainDownloadsLibraryEntity"),h=g.pq("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var w=await b$(m,{mode:"readonly",tj:!0},C=>g.IH.all([T1(C,O,"mainDownloadsLibraryEntity"),T1(C,h,"mainDownloadsListEntity"),T1(C,g.sH,"mainDownloadsListEntity")]));
const [y,L,J]=w;if(y){if(V===g.sH&&J?.downloads)J.downloads=[];else if(L?.downloads){w=g.GQ(V).entityType;for(let C=0;C<L.downloads.length;C++){const E=L.downloads[C];if(w==="mainVideoEntity"&&E.videoItem===V){L.downloads.splice(C,1);break}else if(w==="mainPlaylistEntity"&&E.playlistItem===V){L.downloads.splice(C,1);break}}}await b$(m,{mode:"readwrite",tj:!0},C=>{const E=[rx(C,y,"mainDownloadsLibraryEntity")];L&&E.push(rx(C,L,"mainDownloadsListEntity"));J&&E.push(rx(C,J,"mainDownloadsListEntity"));
return g.IH.all(E)})}},KV=async function(m,V){const O=g.pq(V,"transfer"),h=g.pq(V,"videoDownloadContextEntity");
m=await b$(m,{mode:"readonly",tj:!0},L=>g.IH.all([T1(L,O,"transfer"),T1(L,h,"videoDownloadContextEntity")]));
const [w,y]=m;return{videoId:V,cotn:w?.cotn,offlineModeType:y?.offlineModeType}},WJ=async function(m,V,O,h,w){const y=g.pq(m,"musicTrack"),L=g.pq(m,"transfer");
var J=await b$(V,{mode:"readonly",tj:!0},U=>g.IH.all([T1(U,y,"musicTrack"),T1(U,L,"transfer"),$g(U,"musicTrack"),$g(U,"offlineOrchestrationActionWrapperEntity")]));
const [C,E,q,M]=J;C&&(J=await jsH(C,q),await x2(J));const f=[];for(const U of M){J=g.GQ(U.key).entityId;var x=Mk(U);x=g.GQ(x.action.entityKey).entityId;J!==m&&x!==m||yD(O,U.actionProto)||f.push(U.key)}await b$(V,{mode:"readwrite",tj:!0},U=>{const H=f.map(k=>DK(U,k));
H.push(DK(U,y,{NH:!0}));return g.IH.all(H)});
jI(E);w&&v$(w);l$(h,{entityKey:y,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},Xc=async function(m,V,O,h,w){const y=g.pq(m,V),L=g.pq("music_downloads_library_id","musicDownloadsLibraryEntity");
var J=await b$(O,{mode:"readonly",tj:!0},b=>g.IH.all([T1(b,y,V),T1(b,L,"musicDownloadsLibraryEntity"),$g(b,V),$g(b,"offlineOrchestrationActionWrapperEntity")]));
const [C,E,q,M]=J;C&&(J=await jsH(C,q),await x2(J));let f=[];J=new Map;if(C){f=await LRI(C,q,E);for(var x of f){const b=g.GQ(x).entityId;J.set(b,{videoId:b,playlistId:m,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}x=await eA(O,"transfer");for(var U of x)x=g.GQ(U.key).entityId,(x=J.get(x))&&U&&(x.cotn=U.cotn)}const H=[];for(const b of M)U=g.GQ(b.key).entityId,x=Mk(b),U!==m&&x.rootActionId!==m||yD(h,b.actionProto)||H.push(b.key);const k=g.pq(m,V);await b$(O,{mode:"readwrite",tj:!0},
b=>{const c=H.map(n=>DK(b,n));
c.push(DK(b,k,{NH:!0}));return g.IH.all(c)});
if(C&&(f.reverse(),f.length))for(const b of f)(m=g.GQ(b).entityId)&&await WJ(m,O,h,w,J.get(m))},HJ=async function(m,V,O){m=await b$(m,{mode:"readwrite",
tj:!0},h=>{const w=$g(h,"transfer"),y=$g(h,"offlineOrchestrationActionWrapperEntity");return g.IH.all([w,y]).then(([L,J])=>{const C=JUn.map(E=>NV(h,E));
for(const E of J){J=g.GQ(E.actionProto.entityKey).entityType==="musicTrack";const q=E.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";yD(V,E.actionProto)||J&&(!J||q)||C.push(DK(h,E.key,{NH:!0}))}return g.IH.all(C).then(()=>L)})});
for(const h of m)jI(h),m=g.GQ(h.key).entityId,v$({videoId:m,offlineDeleteReason:void 0,cotn:h.cotn}),m=g.pq(m,"musicTrack"),l$(O,{entityKey:m,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await lcc()},CrZ=function(m){let V;
for(const O of m.additionalMetadatas)O.offlineMusicVideoData&&(V=O.offlineMusicVideoData);return{id:g.pq(m.videoId,"musicTrack"),videoId:m.videoId,title:m.title,thumbnailDetails:m.thumbnail,lengthMs:String(Number(m.lengthSeconds)*1E3),albumTitle:V?.releaseTitle,musicVideoType:V?.musicVideoType,contentRating:{explicitType:V?.explicitType},artistNames:V?.byline||V?.channelName,downloadMetadata:g.pq(m.videoId,"musicTrackDownloadMetadataEntity")}},LRI=async function(m,V,O){const h=[],w=new Set;
if(O?.downloadedTracks?.length)for(const y of O.downloadedTracks)w.add(y);if(m.tracks){for(const y of m.tracks)w.has(y)||h.push(y);for(const y of V)if(y.id!==m.id&&(V=y.tracks))for(const L of V)V=h.indexOf(L),V!==-1&&h.splice(V,1)}return h},jsH=async function(m,V){const O=LV(m.thumbnailDetails);
for(const h of V)if(h.id!==m.id)for(const w of LV(h.thumbnailDetails))V=O.indexOf(w),V!==-1&&O.splice(V,1);return O},TH=async function(m,V){var O=g.pq("music_downloads_library_id","musicDownloadsLibraryEntity");
let h=await I9(m,O,"musicDownloadsLibraryEntity");h||(h={id:O});O=g.GQ(V).entityType;O==="musicTrack"?h.downloadedTracks?.includes(V)||(h.downloadedTracks=(h.downloadedTracks??[]).concat(V)):O==="musicPlaylist"?h.downloadedPlaylists?.includes(V)||(h.downloadedPlaylists=(h.downloadedPlaylists??[]).concat(V)):O!=="musicAlbumRelease"||h.downloadedAlbumReleases?.includes(V)||(h.downloadedAlbumReleases=(h.downloadedAlbumReleases??[]).concat(V));await nW(m,h,"musicDownloadsLibraryEntity")},$2=async function(m,
V){var O=g.pq("music_downloads_library_id","musicDownloadsLibraryEntity");
if(O=await I9(m,O,"musicDownloadsLibraryEntity")){var h=g.GQ(V).entityType;let w;h==="musicTrack"?w=O.downloadedTracks:h==="musicPlaylist"&&(w=O.downloadedPlaylists);if(w?.length)for(h=0;h<w.length;h++)if(w[h]===V){w.splice(h,1);break}await nW(m,O,"musicDownloadsLibraryEntity")}},EdG=function(m){var V=m.videos;
m=[];const O=[];if(V)for(const w of V){var h=w.offlineVideoData.videoId;V=g.pq(h,"musicTrack");h=g.pq(h,"musicTrackDownloadMetadataEntity");m.push(V);O.push(h)}return{DC:m,Lt:O}},Y2=function(m,V,O){V={track:CrZ(V)};
O&&(V.playlistId=O);if(m=g.T(m.actionMetadata,qvA))V.maximumDownloadQuality=m.maximumDownloadQuality;return{musicTrackEntityActionMetadata:V}},f2W=async function(m){var V=g.ai();
m=$YW(m);const O=g.jN(Mqn);try{var h=await g.s4(V,m,O,void 0,{ys:!0})}catch(w){if(w instanceof g.Zh)throw h=`GetOffline network manager error: ${w.message}`,B$(h,w),Error(h);B$("GetOffline fetch request error",w);throw Error("GetOffline fetch request error");}V=h.errorMetadata?.status;if(!h)throw B$("Network request failed"),Error("Network request failed");if(V!==void 0)k2(V);else if(!h.videos||!h.videos.length)throw B$("No data"),Error("No data");return h.videos.map(w=>w.offlineVideoData)},rE=async function(m){var V=
g.ai();
m=YVa(m);const O=g.jN(Mqn);try{var h=await g.s4(V,m,O,void 0,{ys:!0})}catch(w){if(w instanceof g.Zh)throw h=`GetOffline network manager error for playlist: ${w.message}`,B$(h,w),Error(h);B$("GetOffline fetch request error for playlist",w);throw Error("GetOffline fetch request error for playlist");}V=h.errorMetadata?.status;if(!h)throw B$("Network request failed for playlist"),Error("Network request failed for playlist");if(V!==void 0)k2(V,"playlist");else if(!h.playlists||!h.playlists.length)throw B$("No data for playlist"),
Error("No data for playlist");return h.playlists.map(w=>w.offlinePlaylistData)},R6z=async function(m,V,O,h){const w=await z1();
if(!w)return[];var y=[];h?.length?y=h:y=await eA(w,"mainPlaylistEntity");if(!y.length)return[];h=[];const L=Date.now()/1E3;for(const q of y){var J=q.downloadState?await I9(w,q.downloadState,"mainPlaylistDownloadStateEntity"):void 0,C=(y=q?.entityMetadata)&&y.nextAutoRefreshIntervalSeconds?Number(y.nextAutoRefreshIntervalSeconds):NaN;C=Number.isNaN(C)?m:C;var E=J?.lastSyncedTimestampMillis?Number(J?.lastSyncedTimestampMillis)/1E3:0;J=J?.addedTimestampMillis?Number(J?.addedTimestampMillis)/1E3:0;if(O||
!y||E+C<=L){C=[];if(q.videos?.length)for(const M of q.videos)E=JSON.parse(g.GQ(M).entityId),E.videoId&&C.push(E.videoId);E="0";y&&(E=String(Number(y.offlineLastModifiedTimestampSeconds??0).toFixed()));h.push({playlistId:q.playlistId,videoIds:C,offlineLastModifiedTimestamp:E,autoSync:V,offlineDateAddedTimestamp:String(J.toFixed())})}}return h.length?await xcZ(h):[]},odH=async function(){var m=await z1();
if(!m)return!1;m=await eA(m,"refresh");if(!m[0]?.refreshTime)return!1;m=Number(m[0].refreshTime);const V=Date.now()/1E3;return isFinite(m)&&V>=m},AUI=async function(m,V){let O;
try{const h=await gd5(m,V);await Vqn(h);O=h6z(h)}catch(h){B$("getAndProcessSmartDownloadsResponse request or processing error",h)}return O},UcG=async function(m,V,O,h){const w=await z1();
if(!w)return[];var y=[];h?.length?y=h:y=await eA(w,"musicPlaylist");if(!y.length)return[];h=[];const L=Date.now()/1E3;for(const E of y){var J=(y=E?.entityMetadata)&&y.nextAutoRefreshIntervalSeconds?Number(y.nextAutoRefreshIntervalSeconds):NaN;const q=Number.isNaN(J)?m:J;let M=J=0;var C="DOWNLOAD_SYNC_STATE_UNKNOWN";E.downloadMetadata&&(C=await I9(w,E.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),J=Number(C?.addedTimestampMillis??"0")/1E3,M=Number(C?.lastModifiedTimestampMillis??"0")/1E3,
C=C?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(O||C!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!y||Number(y.lastSyncedTimestampSeconds??0)+q<=L){y=[];if(E.tracks?.length)for(const f of E.tracks)y.push(g.GQ(f).entityId);h.push({playlistId:E.playlistId,videoIds:y,offlineLastModifiedTimestamp:String(M.toFixed()),autoSync:V,offlineDateAddedTimestamp:String(J.toFixed())})}}return h.length?await xcZ(h):[]},gd5=async function(m,V){var O=g.ai(),h=await z1();
let w;h&&(w=await bkG(h));h=w;m={context:g.wH(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:m},offlineClientState:h,clientStateRequestData:{preferredFormatType:V}}}};V=g.jN(dc5);try{var y=await g.s4(O,m,V,void 0,{ys:!0})}catch(L){if(L instanceof g.Zh)throw y=`DPS network manager error for smart downloads: ${L.message}`,B$(y,L),Error(y);B$("DPS fetch request error for smart downloads",L);throw Error("DPS fetch request error for smart downloads");
}O=y.errorMetadata?.status;if(y)O!==void 0&&k2(O,"smart downloads");else throw B$("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return y},KRA=async function(m,V){var O=g.ai();
m={context:g.wH(),videoPlaybackPositionEntities:m,lastSyncTimestampUsec:V};V=g.jN(tq5);try{var h=await g.s4(O,m,V,void 0,{ys:!0})}catch(w){if(w instanceof g.Zh)throw h=`VPPS network manager error: ${w.message}`,B$(h,w),Error(h);B$("VPPS fetch request error",w);throw Error("VPPS fetch request error");}O=h.errorMetadata?.status;if(h)O!==void 0&&k2(O,"position sync");else throw B$("Network request failed for position sync"),Error("Network request failed for position sync");return h},XSh=async function(m,
V,O){var h=g.ai(),w=O.refreshData,y=O.isEnqueuedForExpiredStreamUrlRefetch,L=O.J5,J=O.offlineSourceData;
O=O.mediaCapabilities;m={entityKey:m};w&&(m.refreshData=w);y&&(m.isExpiredStreamUrlRefetch=y);L&&(m.downloadParameters=L);J&&(m.offlineSourceData=J);V={context:g.u0(V),signatureTimestamp:20430,videos:[m]};O&&(V.mediaCapabilities=O);w=g.jN(WRz);try{var C=await g.s4(h,V,w,void 0,{ys:!0})}catch(E){if(E instanceof g.Zh)throw C=`GetPDE network manager error: ${E.message}`,B$(C,E),Error(C);B$("GetPDE fetch request error",E);throw Error("GetPDE fetch request error");}h=C.errorMetadata?.status;if(C)h!==void 0&&
k2(h,"PDE");else throw B$("Network request failed for PDE"),Error("Network request failed for PDE");return C},k2=function(m,V){V=V?` for ${V}`:"";
if(m===0)throw m=`Empty response body${V}`,B$(m),Error(m);m=`Response with error${V}`;B$(m);throw Error(m);},xcZ=async function(m){var V=g.ai();
m=koc(m);const O=g.jN(H45);try{var h=await g.s4(V,m,O,void 0,{ys:!0})}catch(w){if(w instanceof g.Zh)throw h=`offlinePlaylistSyncCheck network manager error: ${w.message}`,B$(h,w),Error(h);B$("offlinePlaylistSyncCheck fetch request error",w);throw Error("offlinePlaylistSyncCheck fetch request error");}V=h.errorMetadata?.status;if(!h)throw B$("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(V!==void 0)k2(V,"playlist sync");else if(!h.offlinePlaylistSyncCheckDatas||
!h.offlinePlaylistSyncCheckDatas.length)throw B$("No data for playlist sync"),Error("No data for playlist sync");return h.offlinePlaylistSyncCheckDatas.map(w=>w.offlinePlaylistSyncCheckData)},TyJ=async function(m,V){const O=new Map;
for(const h of V)O.set(h,await m.A(h));return O},cJ=function(m,V,O,h,w,y){V=g.pq(V,O);
return{actionType:m,entityKey:V,actionMetadata:{...y,priority:h,retryScheduleIntervalsInSeconds:w}}},kSW=async function(m,V){var O=V.entityKey;
const h=g.T(V.actionMetadata,Ds)?.isEnqueuedForExpiredStreamUrlRefetch;try{let y=void 0;y=await $cz(m,V);let L;try{{const J=g.T(V.actionMetadata,Ds);var w=J?{maximumDownloadQuality:J.maximumDownloadQuality}:void 0}L=await XSh(O,m.W,{isEnqueuedForExpiredStreamUrlRefetch:h,J5:w,offlineSourceData:y})}catch(J){const C=my(V)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";B$("PDE handleAdd error");return Nk(V,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",C,"DOWNLOAD_STATE_FAILED")}await Yv5(m,L,V);return Nk(V,!0,L.orchestrationActions)}catch(y){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",O="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.DB&&y.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",O="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),B$("PDE handleAdd error"),Nk(V,!1,void 0,m,O,"DOWNLOAD_STATE_FAILED")}},
DcM=async function(m,V){const O=V.entityKey,h=g.GQ(O).entityId;
var w=await b$(m.Z,{mode:"readonly",tj:!0},M=>{const f=T1(M,O,"playbackData"),x=T1(M,g.pq(h,"offlineVideoPolicy"),"offlineVideoPolicy");M=T1(M,g.pq(h,"transfer"),"transfer");return g.IH.all([f,x,M])});
const [y,L,J]=w;if(!y||!L)return Nk(V,!0);w=[];var C=y?.playerResponseJson?JSON.parse(y.playerResponseJson):null;if(J&&C&&m.W.Y("html5_refresh_deprecated_downloads")){var E=rUz(m,C,J);w=await cUZ(m,J)}w={lastPlayerResponseTimestampSeconds:y.playerResponseTimestamp,offlineToken:L.offlineToken,formatIds:w};C={};J?.maximumDownloadQuality&&(C.maximumDownloadQuality=J.maximumDownloadQuality);try{let M=void 0;M=await $cz(m,V);try{var q=await XSh(O,m.W,{refreshData:w,J5:C,offlineSourceData:M,mediaCapabilities:E})}catch(f){const x=
my(V)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";B$("PDE handleRefresh error");return Nk(V,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",x,"DOWNLOAD_STATE_FAILED")}await Yv5(m,q,V);return Nk(V,!0,q.orchestrationActions)}catch(M){return m="PDE handleRefresh error",M instanceof Error&&(m=`PDE handleRefresh error: ${M.message}`),E="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",q="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",
M instanceof g.DB&&M.type==="QUOTA_EXCEEDED"&&(E="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",q="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),B$(m),Nk(V,!1,void 0,E,q,"DOWNLOAD_STATE_FAILED")}},$cz=async function(m,V){V=g.GQ(V.entityKey).entityId;
V=g.pq(V,"videoDownloadContextEntity");m=await I9(m.Z,V,"videoDownloadContextEntity");return m?.offlineModeType?{offlineModeType:m.offlineModeType}:void 0},Nk=function(m,V,O,h,w,y){return new bG(V?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",my(m),O,h,w,y)},Yv5=async function(m,V,O){if(V.frameworkUpdates&&g.T(V.frameworkUpdates,UT)){if(g.T(V.frameworkUpdates,UT).mutations&&g.T(V.frameworkUpdates,UT).mutations.length>0&&g.T(V.frameworkUpdates,UT).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const h=g.GQ(g.T(V.frameworkUpdates,UT).mutations[0].entityKey).entityId,w=await KV(m.Z,h),y=g.T(O.actionMetadata,Ds)?.playlistId;
y&&(w.playlistId=y);w.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.vK(m.W)?await o7(h,m.Z,O,m.L,w):g.Fo(m.W)&&await WJ(h,m.Z,O,m.L)}await ZK(g.T(V.frameworkUpdates,UT))}},rUz=function(m,V,O){V=CV(m.W,O.cotn,V);
O=g.CO(V);return g.KF7(V,O,m.W)},cUZ=async function(m,V){const O=[];
if(m=await b$(m.Z,{mode:"readonly",tj:!0},h=>{const w=[],y=V.offlineVideoStreams;if(y)for(const L of y)w.push(T1(h,L,"offlineVideoStreams"));return g.IH.all(w)}))for(const h of m)if(h?.streamsProgress){m=h.streamsProgress;
for(let w=0;w<m.length;w++){const y=JSON.parse(m[w].formatStreamBytes);O.push({itag:y.itag,lmt:y.lastModified,xtags:y.xtags})}}return O},NyM=async function(m,V){V=my(V);
m=await eA(m.Z,"videoPlaybackPositionEntity");if(m.length===0)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",V);try{const O=await nV.getInstance();if(!O)throw Error("prefStorage is undefined");const h=(await O.get("psi"))?.w1??"0",w=await KRA(m,h),y={isPaused:w.watchHistoryPaused,w1:w.syncTimestampUsec};await O.set("psi",y);if(!y.isPaused){const L=g.T(w.frameworkUpdates,UT);w.frameworkUpdates&&L&&await ZK(L)}}catch(O){return B$("PPE handleRefresh error: "+(O instanceof Error?O.message:
"unknown error")),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",V,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",V)},ndn=async function(m,V){const O=my(V),h=g.GQ(V.entityKey).entityId;
try{const w=await nV.getInstance();if(!w)throw Error("prefStorage is undefined");const y=await w.get("psi"),L=g.T(V.actionMetadata,b45);if(y?.isPaused===!1&&L?.lastPlaybackPositionSeconds){const J={key:g.pq(h,"videoPlaybackPositionEntity"),videoId:h,lastPlaybackPositionSeconds:L.lastPlaybackPositionSeconds};await nW(m.Z,J,"videoPlaybackPositionEntity")}}catch(w){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
O)},SvH=async function(m,V){const O=my(V);
try{const h=g.GQ(V.entityKey).entityId;if(h==="!*$_ALL_ENTITIES_!*$")await xYZ(m.Z);else{const w=g.pq(h,"videoPlaybackPositionEntity");await SA(m.Z,w)}}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},SI=async function(m){return TVh(m)},I2H=async function(m){return(await g.QGX(m)).filter(V=>!!V.url).map(V=>
V.url)},I7=function(m,V){var O=g.ct(V);
if(O===1||O===0)return Promise.resolve();(O=m.player?.getVideoData().videoId===V?m.player:null)&&O.stopVideo();m.L=0;return SI(V)},eI=function(m,V,O=!1,h=!0){V=typeof V==="string"?V:V.videoDetails.videoId;
if(g.ct(V)===2){var w=m.player?.getVideoData().videoId===V?m.player:null;w&&w.stopVideo();g.DW(V,2);m.L=2;O?e6A(m.Z):h&&uVc(m.Z)}},Z4z=async function(m,V){const O=my(V);
if(await I9(m.Z,V.entityKey,"transfer"))return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);try{await z6J(m,V)}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},ssA=async function(m,V){const O=my(V),h=await I9(m.Z,V.entityKey,"transfer");
if(!h||h.transferState!=="TRANSFER_STATE_COMPLETE")return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);try{await z6J(m,V,!0)}catch(w){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},FRA=async function(m,V){const O=my(V),h=g.GQ(V.entityKey).entityId,w=await b$(m.Z,{mode:"readonly",
tj:!0},J=>{const C=T1(J,V.entityKey,"transfer");J=T1(J,g.pq(h,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.IH.all([C,J])}),[y,
L]=w;if(!y||y.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);try{y.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await nW(m.Z,y,"transfer");const J=g.GQ(y.key).entityId;P$({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:J,Os:y,offlineModeType:L?.offlineModeType})}catch(J){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},z6J=async function(m,V,O=!1){const h=g.T(V.actionMetadata,a2I),w=g.GQ(V.entityKey).entityId,y=g.pq(w,"downloadStatusEntity");
var L=await b$(m.Z,{mode:"readonly",tj:!0},q=>{const M=T1(q,y,"downloadStatusEntity");q=T1(q,g.pq(w,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.IH.all([M,q])});
const [J,C]=L;L="TRANSFER_STATE_TRANSFER_IN_QUEUE";J?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(L="TRANSFER_STATE_PAUSED_BY_USER");const E={key:V.entityKey,transferState:L,cotn:g.Rl(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:h?.maximumDownloadQuality,preferredAudioTrack:h?.preferredAudioTrack,transferRetryCount:0,isRefresh:O,hasLoggedFirstStarted:!1};await b$(m.Z,{mode:"readwrite",tj:!0},q=>{const M=[];O&&M.push(DK(q,g.pq(w,"offlineVideoStreams")));M.push(rx(q,E,"transfer"));
return g.IH.all(M)});
O&&await SI(w);P$({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:w,Os:E,offlineModeType:C?.offlineModeType})},GSJ=function(m,V,O,h){if(!m.action.entityKey)throw Error("entityKey is missing.");
const {pY:w,entityId:y}=g.GQ(m.action.entityKey),L={entityType:w,entityId:y,offlineOrchestrationActionType:m.action.actionType,orchestrationAction:{orchestrationActionId:m.actionId}};V&&(L.offlineOrchestrationActionResult=V.status,L.isRetryable=O?!1:V.Z,V.L&&(L.offlineOrchestrationFailureReason=i4$(V.L,L.isRetryable)));m.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(L.offlineModeType=m.action.actionMetadata.offlineLoggingData.offlineModeType);h&&(L.additionalOrchestrationActions=h.map(J=>
({orchestrationActionId:J.actionId})));
return L},i4$=function(m,V){return m!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||V?m==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&V?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":m:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},uG=function(m,V){const O={offlineOrchestrationContext:GSJ(m)};
V=DYc(V,O);NVM(c9n(),V,m.rootActionId)},zH=function(m,V,O,h=[]){V={offlineOrchestrationContext:GSJ(m,V,O,h)};
V=DYc(3,V);NVM(c9n(),V,m.rootActionId)},pSa=function(m,V){for(const O of V)uG(O,1),m.actions.push(O);
m.actions.sort(m.Z)},ByG=function(m,V){if(V)for(let O=0;O<m.actions.length;O++)if(V==="!*$_ALL_ENTITIES_!*$"&&m.actions[O].actionId!==V||V!=="!*$_ALL_ENTITIES_!*$"&&m.actions[O].rootActionId===V&&m.actions[O].actionId!==V)m.actions.splice(O,1),O--},l2W=function(m,V){for(const O of m.actions)if(O.actionId===V)return!0;
return!1},m0n=async function(m,V,O,h,w){m=new Qsa(m,V,O,h,w);
await vdZ(m);PrG(m);return m},vdZ=async function(m){const V=await eA(m.A,"offlineOrchestrationActionWrapperEntity");
await Zs(m,V)},PrG=function(m){const V=m.Z.actions[0];
return m.D?(V?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&m.D[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(m.T=!0),Promise.resolve()):Voa(m)},Voa=async function(m){if(m.D)throw Error("Already processing an action");
if(!m.EH()){var V=m.Z.actions.shift();sQn(m.Zu,!V);if(V!==void 0){V.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&V.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&ByG(m.Z,V.actionId);var O="";V.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&V.rootActionId===V.actionId&&(O=V.actionId);var h=[V];m.D=h;if(V=m.Qt[V.entityType]){for(const w of h)uG(w,2);try{const w=await TyJ(V,h.map(y=>y.action));
for(const y of h){const L=w.get(y.action);await OxZ(m,y,L)}ByG(m.Z,O)}catch(w){B$("Orchestration error",w);try{await hDM(m,h)}catch(y){B$("Orchestration retry error",y);for(const L of h)L.retryScheduleIndex<3&&pSa(m.Z,[L])}}finally{m.D=void 0}}else m.D=void 0;await Voa(m)}}},OxZ=async function(m,V,O){var h=V.retryScheduleIndex+2===3;
if(O.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var w=void 0;try{w=O.D?.map(y=>m.createAction(y,V))}catch(y){zH(V,O,h);
l$(m.N,{entityKey:V.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});B$("Orchestration subactions creation error",y);return}zH(V,O,h,w);if(w){const y=w.map(J=>fV(J));
let L=0;for(;L<w.length&&!m.T;)await b$(m.A,{mode:"readwrite",tj:!0},J=>{const C=[];C.push(c$(J,y.slice(L,L+10),"offlineOrchestrationActionWrapperEntity"));return g.IH.all(C)}),L+=10;
if(m.T){m.T=!1;return}}O=fV(V);await SA(m.A,O.key);uG(V,4)}else if(O.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(zH(V,O,h),O.Z&&V.retryScheduleIndex+1<3)await hDM(m,[V]);else{h={entityKey:V.action.entityKey,failureReason:O?.A?O.A:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};w=void 0;g.vK(m.W)?w="mainVideoDownloadStateEntity":g.Fo(m.W)&&(w="musicTrackDownloadMetadataEntity");if(w&&O.downloadState){const y=g.GQ(V.action.entityKey).entityId;await wE(y,w,m.A,O.downloadState)}l$(m.N,h);O.downloadState===
"DOWNLOAD_STATE_FAILED"&&m.W.Y("html5_auto_retry_failed_pde_actions")||(B$("Orchestration result is not retryable, deleting action"),await SA(m.A,fV(V).key))}},hDM=async function(m,V){for(const O of V){const h=O.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let w=1;O.retryScheduleIndex<h.length&&(w=h[O.retryScheduleIndex]);O.Z=w*1E3+Date.now();O.retryScheduleIndex++}await wiI(m,V)},yzZ=async function(m,V){return(await eA(m.A,"offlineOrchestrationActionWrapperEntity",V)).filter(dYn)},Zs=async function(m,V){let O=[];
var h=Infinity;let w=4E3;for(const L of V){V=Number(L.enqueueTimeSec);const J=jyZ(V);var y=L.retryScheduleIndex;y=y!=null&&y>0;J>0&&y?(h=Math.min(h,V),w=Math.min(J,w)):O.push(L)}isFinite(h)&&(!m.L.isActive()||h<m.X)&&(m.X=h,m.L.start(w));m.U.vj()||(h=O.length,O=O.filter(L=>!LxA.includes(L.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),h=O.length<h,!m.L.isActive()&&h&&m.L.start(1));
O.length>0&&JzA(m,O);await PrG(m)},jyZ=function(m){m=m*1E3-Date.now();
return m>4E3?4E3:m},JzA=function(m,V){V.length!==0&&V.forEach(O=>{O=Mk(O);
O.retryScheduleIndex<3&&pSa(m.Z,[O])})},C9z=async function(m){var V=await yzZ(m);
const O=[];for(const h of V)V=g.GQ(h.key).entityId,l2W(m.Z,V)||O.push(h);await Zs(m,O)},wiI=function(m,V){if(V.length===0)return Promise.resolve([]);
V=V.map(O=>fV(O));
return fc5(m.A,V)},EwZ=async function(m,V){const O=V.videoId;
let h=!0;if(V.captionTracks.length){const w=Bbh(V);m.Z=new g.Ka(m.oY,V,w)}else if(V.Ir)m.Z=new g.Wx(m.oY,V.Ir,O,g.xWm(V),V.YF,V.eventId),h=V.YF;else return;return new Promise(w=>{m.Z?.T({DM:async()=>{await m.DM(O,h);w()},
fQ:()=>{}})})},qA5=async function(m){m=await HkA(m);
return!!m&&m.length>0},Mon=async function(m,V){if(V.length===0)return[];
const O=V.map(w=>g.pq(w,"transfer")),h=(await eA(m.Z,"transfer",O)).filter(dYn).map(w=>g.GQ(w.key).entityId);
m=V.filter(w=>h.indexOf(w)===-1);
if(m.length===0)return[];for(const w of m)await SI(w);return m},RDW=async function(m,V,O,h,w,y){let L="STREAM_TYPE_UNKNOWN";
O.video&&O.audio?(L="STREAM_TYPE_AUDIO_AND_VIDEO",B$("unexpected stream type")):O.video&&!O.audio?L="STREAM_TYPE_VIDEO":!O.video&&O.audio&&(L="STREAM_TYPE_AUDIO");const J=g.pq(V,"offlineVideoStreams"),C={numBytesDownloaded:w.toFixed(),numTotalBytes:y.toFixed(),streamType:L,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(h),itag:L==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(O.itag):void 0};await b$(m,{mode:"readwrite",tj:!0},E=>{const q=T1(E,J,"offlineVideoStreams"),M=T1(E,
g.pq(V,"transfer"),"transfer");return g.IH.all([q,M]).then(([f,x])=>{if(!x)return DK(E,J).then(()=>{});
var U=fpG(f);f=x0A(f,h,C,J);const H=rx(E,f,"offlineVideoStreams");fpG(f)>U&&(x.lastProgressTimeMs=Date.now().toString());U=[H];x.offlineVideoStreams||(x.offlineVideoStreams=[]);x.offlineVideoStreams.indexOf(J)===-1&&(x.offlineVideoStreams.push(J),U.push(rx(E,x,"transfer")));return g.IH.all(U)})})},owW=async function(m,V){V=g.pq(V,"offlineVideoStreams");
if((V=await I9(m,V,"offlineVideoStreams"))&&V.streamsProgress){for(const O of V.streamsProgress)O.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",O.numTotalBytes!==O.numBytesDownloaded&&(O.numBytesDownloaded=O.numTotalBytes);await nW(m,V,"offlineVideoStreams")}},x0A=function(m,V,O,h){if(m&&m.streamsProgress){h=m;
a:{V=`${V.itag};${V.xtags}`;var w=m.streamsProgress;for(let y=0;y<w.length;y++){const L=JSON.parse(w[y].formatStreamBytes);if(`${L.itag};${L.xtags}`===V){w[y]=O;O=w;break a}}w.push(O);O=w}h.streamsProgress=O}else m={key:h,streamsProgress:[O]};return m},fpG=function(m){if(m?.streamsProgress){let V=0;
m=m.streamsProgress;for(let O=0;O<m.length;O++){const h=m[O];isNaN(Number(h.numBytesDownloaded))?B$("stream progress bytes number invalid"):V+=Number(h.numBytesDownloaded)}return V}return 0},e6A=async function(m){if(m.Z){const V=m.Z;
m.D.stop();await sT(m,"TRANSFER_STATE_PAUSED_BY_USER");const O=V?.key?g.GQ(V.key).entityId:"";O&&m.L&&await wE(O,m.L,m.A,"DOWNLOAD_STATE_PAUSED");const h=await Fc(m,O);ikH({videoId:O,Os:V,offlineModeType:h})}else a7(m,"onTransferPausedByUser");iG(m);GH(m)},uVc=async function(m){if(m.Z){m.D.stop();
await sT(m,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var V=m.Z;(V=V?.key?g.GQ(V.key).entityId:"")&&m.L&&await wE(V,m.L,m.A,"DOWNLOAD_STATE_PAUSED");iG(m)}else a7(m,"onTransferPausedByNetwork")},pV=async function(m){if(m.Z){m.D.start(108E5);
await sT(m,"TRANSFER_STATE_TRANSFERRING");var V=m.Z;(V=V?.key?g.GQ(V.key).entityId:"")&&m.L&&await wE(V,m.L,m.A,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else a7(m,"onTransferStart")},gw$=async function(m,V,O){if(m.Z){m.Z.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await pV(m);
var h=Date.now();h-m.mS>1E3&&(m.mS=h,await RDW(m.A,O.videoId,O.A,O.Qn,O.bytesDownloaded,O.Z),!m.V||m.V&&h-m.Zu>m.YN)&&(m.Zu=h,h=await Fc(m,V),acA({videoId:V,Os:m.Z,offlineModeType:h},O.bytesDownloaded,O.Z));m.D.start(108E5)}else a7(m,`onTransferProgress: ${V}`)},U0H=async function(m){if(m.Z){var V=m.Z;
m.D.stop();if(V&&m.T){var O=CV(m.api.B(),V.cotn,m.T);await Aza(m,O)}await sT(m,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(O=V?.key?g.GQ(V.key).entityId:"")&&m.L&&await wE(O,m.L,m.A,"DOWNLOAD_STATE_COMPLETE");await owW(m.A,O);var h=await Fc(m,O);P$({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:O,Os:V,offlineModeType:h});iG(m);GH(m)}else a7(m,"onTransferComplete")},d0Z=async function(m){await Wpz();
m=m.Ae;var V=g.ri();V=Object.keys(V);await Mon(m,V)},Wxh=async function(m){m=(await eA(m.A,"transfer")).filter(toH).sort(Kx$);
return m.length===0?void 0:m[0]},TBz=async function(m,V){if(!m.X){m.X=!0;
m.Z=V;var O=g.GQ(m.Z.key).entityId;if(m.Z.transferState==="TRANSFER_STATE_TRANSFERRING"){var h=await Fc(m,O);P$({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:O,Os:m.Z,offlineModeType:h})}else m.Z.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||m.Z.transferRetryCount||m.Z.hasLoggedFirstStarted||(h=await Fc(m,O),m.Z.hasLoggedFirstStarted=!0,await XiG(m),acA({videoId:O,Os:m.Z,offlineModeType:h},void 0,void 0,!0));await pV(m);O=null;try{O=await Hxc(m,
V),m.T=O}catch(w){B$("error getting player response",w,V.cotn);await m.CS("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}h=CV(m.api.B(),V.cotn,O);await Aza(m,h);h.W7=await I2H(h.videoId);O=m.N;V=V.maximumDownloadQuality;h.getPlayerResponse();g.DW(h.videoId,2);O.L=2;O.A=!1;O.player?.dispose();O.player=O.api.S4(h);O.player.FK({localmediachange:O.bx,signatureexpired:O.Yn,statechange:O.D},O);O.Y("html5_generate_content_po_token")&&O.player.Y9();V=O.gR(V);O.player.Av(g.aB(V,V,!0,"m"),!1);O.player.NT(!1);
m.D.start(108E5)}},iG=function(m){m.Z=void 0;
m.T=void 0;m.D.stop()},GH=async function(m,V=!1){if(m.Z)throw Error("Already downloading a video");
m.Zu=0;m.X=!1;const O=await Wxh(m);Fph(m.H6,!O);O&&m.U.vj()?(V&&await new Promise(h=>{g.er(h,1E3)}),await TBz(m,O)):!O&&m.Z&&iG(m)},Fc=async function(m,V){return(await I9(m.A,g.pq(V,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},$0Z=async function(m){m.T&&(await I7(m.N,m.T.videoDetails.videoId),iG(m))},Aza=async function(m,V){try{(V.captionTracks.length||V.Ir)&&!await qA5(V.videoId)&&await EwZ(m.Nf,V)}catch(O){B$("Caption downloading error",O,V.cotn)}},XiG=
async function(m,V){if(m.Z){var O=m.Z;
await b$(m.A,{mode:"readwrite",tj:!0},h=>{const w=[rx(h,O,"transfer")];V&&w.push(V(h));return g.IH.all(w)})}},Hxc=async function(m,V){V=g.GQ(V.key).entityId;
V=g.pq(V,"playbackData");m=await I9(m.A,V,"playbackData");if(m?.playerResponseJson)return JSON.parse(m.playerResponseJson);throw Error("No PlayerResponse found");},sT=async function(m,V,O,h){if(m.Z){m.Z.transferState=V;
m.Z.failureReason=h;try{await XiG(m,w=>O?$g(w,"offlineVideoStreams",m.Z.offlineVideoStreams).then(y=>{for(const L of y)if(L&&L.streamsProgress)for(const J of L.streamsProgress)J.streamState=O;return c$(w,y.filter(L=>!!L),"offlineVideoStreams")}):g.IH.resolve(void 0))}catch(w){w instanceof g.DB&&w.type==="QUOTA_EXCEEDED"&&await m.CS("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else a7(m,`saveTransferState: ${V}`)},a7=function(m,V){m.api.uH("woffle",{mcte:V});
B$("missing current transfer entity.")},YAM=function(m){const V=(m.Z.transferRetryCount||0)<3;
V&&(m=m.Z,m.transferRetryCount=(m.transferRetryCount||0)+1);return V},kjn=async function(m,V="TRANSFER_FAILURE_REASON_UNKNOWN"){m.Z||a7(m,`setTransferToFailed: ${V}`);
var O="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";V==="TRANSFER_FAILURE_REASON_NETWORK"?O="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":V==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(O="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await sT(m,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",V);l$(m.S,{entityKey:m.Z?.key,failureReason:O});O=m.Z?g.GQ(m.Z.key).entityId:"";const h=await Fc(m,O);m={videoId:O,Os:m.Z,offlineModeType:h};O={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};V&&(O.transferFailureReason=V,O.failureReason=Gon(V));P$(O,m)},toH=function(m){return BJ[m.transferState]!==void 0},Kx$=function(m,V){const O=BJ[m.transferState],h=BJ[V.transferState];
return O!==h?O-h:Number(m.enqueuedTimestampMs)-Number(V.enqueuedTimestampMs)},rzJ=async function(m){g.Zj(m.api,"onOrchestrationBecameLeader");
await m.Iy()},NBh=async function(m){const V=await z1();
if(V){m.A=new czz(V,m.api,m.L,m.Z);var O=m.U(V);m.X=await m0n(V,O,m.L,m.Z,m.W);await D0c(m)}else B$("PES is undefined")},D0c=async function(m){if(m.A){m.A.Z||await GH(m.A);
m.W.Y("woffle_enable_main_downloads_library")&&await m.ze();m.W.Y("html5_offline_playback_position_sync")&&(await m.mS(),await m.PZ(864E5));await m.refreshAllStaleEntities(43200,!0);await m.V();m.W.Y("html5_retry_downloads_for_expiration")&&await m.oR();m.Zu=g.uC(()=>{m.refreshAllStaleEntities(43200,!0);m.V()},9E5);
g.go(g.UL(),()=>m.JS());
var V=await z1();await uYz(V);ZkZ(m.L)}else B$("transferManager is undefined")},bxa=async function(){const m=await z1();
if(!m)return[];const V=Date.now()/1E3,O=await eA(m,"offlineVideoPolicy");for(const h of O)h.expirationTimestamp&&Number(h.expirationTimestamp)<V&&(h.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",h.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await nW(m,h,"offlineVideoPolicy"));return O.map(h=>h.key)},lG=async function(m,V,O,h,w){var y=await z1();
if(!y)return[];V=V.map(L=>{var J=g.pq(L,O);J={actionType:h,entityKey:J,actionMetadata:{...ET(),...w}};h!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(J.actionMetadata.priority=0);L=new qk(O,L,J);return fV(L)});
y=fc5(y,V);zwn(m.L);return y},nwc=async function(m,V,O,h){const w=[];
for(const y of V)if(!y.upToDate&&(!O||y.shouldAutoSyncMetadata)&&y.playlistId){V={};switch(h){case "mainPlaylistEntity":V={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:y.checkInSeconds,autoSync:O}};break;case "musicPlaylist":V={musicPlaylistEntityActionMetadata:{autoSync:O}}}(V=await lG(m,[y.playlistId],h,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",V))&&w.push(...V)}return w},SAM=async function(m,V){if(V.length){const O=ET();
g.bE(O,Ds,{isEnqueuedForExpiredStreamUrlRefetch:!0});m.api.uH("qrd",{v:V.length});return lG(m,V,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",O)}return[]},eDZ=async function(m,V){const O=my(V);
var h=g.GQ(V.entityKey).entityId;let w=[];try{w=await IpA(m,h),m.W.Y("woffle_enable_main_downloads_library")&&w?.length&&await dE(m.Z,[V.entityKey])}catch(L){return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.DB&&L.type==="QUOTA_EXCEEDED"?(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):B$("Playlist add error"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
O,void 0,V,h)}const y=[];m.W.Y("html5_offline_prevent_redownload_downloaded_video")&&(w=await Jo(m.Z,"mainVideoEntity",w));if(w?.length)for(const L of w)m=L.offlineVideoData,m?.videoId&&y.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m.videoId,"mainVideoEntity",Number(V.actionMetadata?.priority||0)+1,QD,vJ(V,m,h)));return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,y)},zDH=async function(m,V){const O=my(V);
var h=V.entityKey,w=g.GQ(h).entityId,y=[],L=!1;w==="!*$_ALL_ENTITIES_!*$"?(L=!0,y=await eA(m.Z,"mainPlaylistEntity")):(h=await I9(m.Z,h,"mainPlaylistEntity"))&&y.push(h);if(!y?.length)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);var J=g.T(V.actionMetadata,ufn);h=J?.nextAutoRefreshIntervalSeconds;const C=J?.autoSync;let E=[],q=!0;J=!0;let M=!1;if(L||C!==!1){try{E=await R6z(0,!!C,!0,y)}catch(H){H instanceof Error&&H.message==="No data"?w==="!*$_ALL_ENTITIES_!*$"?await Ao(m.Z,V,m.L,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await gE(w,m.Z,V,m.L):H instanceof Error&&H.message==="Empty response body"&&B$(H.message)}if(!E.length||!L&&E[0].playlistId!==w)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)}if(L){V=[];for(var f of E)f.upToDate||C&&!f.shouldAutoSyncMetadata||!f.playlistId||V.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",f.playlistId,"mainPlaylistEntity",0,QD,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:f.checkInSeconds,autoSync:C}}));
return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,V)}E.length&&(f=E[0],M=!!f.upToDate,C&&(q=f.shouldAutoSyncMetadata??!0,J=f.shouldAutoSyncVideos??!0,f.checkInSeconds&&(h=f.checkInSeconds)));if(M||!q)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);f=[];y=y[0];L=y.downloadState?await I9(m.Z,y.downloadState,"mainPlaylistDownloadStateEntity"):void 0;L=L?.addedTimestampMillis?String(L.addedTimestampMillis):void 0;try{f=await IpA(m,w,L,h)}catch(H){if(H instanceof Error&&H.message===
"No data for playlist")await gE(w,m.Z,V,m.L);else if(H instanceof Error&&H.message==="Empty response body for playlist")B$(H.message);else return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",w="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.DB&&H.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",w="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,V,w)}if(!J)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
O);m=[];h=new Map;if(f?.length)for(var x of f)J=x.offlineVideoData,J?.videoId&&h.set(J.videoId,J);x=new Map;J=[];if(y?.videos?.length)for(var U of y.videos)if(y=JSON.parse(g.GQ(U).entityId).videoId)h.has(y)?(x.set(y,h.get(y)),h.delete(y)):J.push(y);U=Number(V.actionMetadata?.priority||0)+1;for(const [H,k]of h.entries())m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",H,"mainVideoEntity",U,QD,vJ(V,k,w)));for(const [H,k]of x.entries())m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",H,"mainVideoEntity",
U,QD,vJ(V,k,w)));for(const H of J)m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",H,"mainVideoEntity",0,QD,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:w}}));return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,m)},ZxW=async function(m,V){const O=my(V);
try{const h=g.GQ(V.entityKey).entityId;h==="!*$_ALL_ENTITIES_!*$"?await Ao(m.Z,V,m.L,V.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await gE(h,m.Z,V,m.L),m.W.Y("woffle_enable_main_downloads_library")&&await to(m.Z,V.entityKey))}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
O)},IpA=async function(m,V,O,h){V=await rE([V]);
const {mainPlaylistEntity:w,S8:y}=await syc(m,V[0],O,h);m=vXW(w,y?.avatar);try{await R7(m)}catch(L){L instanceof Error&&L.message==="Failed to fetch"&&B$(L.message)}return V[0].videos},vJ=function(m,V,O){V={offlineVideoData:V,
playlistId:O};if(m=g.T(m.actionMetadata,ufn))V.maximumDownloadQuality=m.maximumDownloadQuality;return{mainVideoEntityActionMetadata:V}},syc=async function(m,V,O,h){const w=Date.now().toString();
O||(O=w);var y=V.videos;const L=V.playlistId,J=[],C=[];if(y)for(const f of y){y=f.offlineVideoData;if(!y||!y.videoId)throw B$("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");y=y.videoId;y={id:g.pq(JSON.stringify({videoId:y,playlistId:L}),"mainPlaylistVideoEntity"),video:g.pq(y,"mainVideoEntity")};J.push(y);C.push(y.id)}let E;const q={key:g.pq(L,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:O,lastSyncedTimestampMillis:w},M={key:g.pq(L,"mainPlaylistEntity"),
playlistId:L,videos:C,title:V.title,thumbnailStyleData:FxM(V),visibility:apz(V),downloadState:q.key};V.channel&&(O=V.channel.offlineChannelData,E=ixc(g.pq(L,"ytMainChannelEntity"),O),M.channelOwner=E.id);M?.entityMetadata?(M.entityMetadata.offlineLastModifiedTimestampSeconds=V.lastModifiedTimestamp,h&&(M.entityMetadata.nextAutoRefreshIntervalSeconds=String(h))):M&&(M.entityMetadata={nextAutoRefreshIntervalSeconds:h?String(h):void 0,offlineLastModifiedTimestampSeconds:V.lastModifiedTimestamp});try{await b$(m.Z,
{mode:"readwrite",tj:!0},f=>{var x=rx(f,M,"mainPlaylistEntity");const U=rx(f,q,"mainPlaylistDownloadStateEntity");x=[x,U];for(const H of J)x.push(rx(f,H,"mainPlaylistVideoEntity"));E&&x.push(rx(f,E,"ytMainChannelEntity"));return g.IH.all(x)})}catch(f){throw B$("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:M,S8:E,vAt:J}},FxM=function(m){const V=[];
var O=m.videos;O&&O.length>0&&V.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:O[0].offlineVideoData.thumbnail}}});if((m=m.additionalMetadadatas)&&m.length>0)for(const h of m)switch(m=h.offlineBundleItemPlaylistData,O={collageThumbnail:{coverThumbnail:m?.coverThumbnail}},m?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":V.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:O});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":V.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:O});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":V.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:O});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":V.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:O})}return V},apz=function(m){switch(m.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},ixc=function(m,V){return{id:m,
channelId:V.channelId,title:V.title,avatar:V.thumbnail}},BB5=async function(m,V){const O=my(V);
var h=g.GQ(V.entityKey).entityId;const w=g.T(V.actionMetadata,PJ),y=!w?.playlistId;try{await GjM(m,h,void 0,w?.offlineVideoData,y)}catch(L){return h="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.DB&&L.type==="QUOTA_EXCEEDED"&&(h="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,h,V)}m=Number(V.actionMetadata?.priority||
0)+1;V=(V=g.T(V.actionMetadata,PJ))?{playbackDataActionMetadata:{maximumDownloadQuality:V.maximumDownloadQuality}}:void 0;h=cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",h,"playbackData",m,piH,V);return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,[h])},lpI=async function(m,V){const O=my(V),h=g.GQ(V.entityKey).entityId;
var w=await I9(m.Z,V.entityKey,"mainVideoEntity"),y=w?await I9(m.Z,w.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!w||!y)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);let L;try{await GjM(m,h,y.addedTimestampMillis,g.T(V.actionMetadata,PJ)?.offlineVideoData),w=1,w=Number(V.actionMetadata?.priority||0)+1,L=cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",h,"playbackData",w,piH)}catch(J){if(J instanceof Error&&J.message==="No data"){w=await KV(m.Z,h);if(y=g.T(V.actionMetadata,
PJ)?.playlistId)w.playlistId=y;w.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await o7(h,m.Z,V,m.L,w)}else if(J instanceof Error&&J.message==="Empty response body")B$(J.message);else return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",J instanceof g.DB&&J.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
O,void 0,m,V)}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,L?[L]:void 0)},Qy$=async function(m,V){const O=my(V);
try{const h=g.GQ(V.entityKey).entityId;if(h==="!*$_ALL_ENTITIES_!*$")await Ao(m.Z,V,m.L,V.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const w=await KV(m.Z,h),y=g.T(V.actionMetadata,PJ)?.playlistId;y&&(w.playlistId=y);w.offlineDeleteReason=V.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await o7(h,m.Z,V,m.L,w);m.W.Y("woffle_enable_main_downloads_library")&&await to(m.Z,V.entityKey)}}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},GjM=async function(m,V,O,h,w){h||(h=(await f2W([V]))[0]);
const {mainVideoEntity:y,channelEntity:L}=await vwn(m,h,O,w);try{const J=LV(y.thumbnail),C=LV(L.avatar);await R7(J.concat(C))}catch(J){J instanceof Error&&J.message==="Failed to fetch"&&B$(J.message)}},vwn=async function(m,V,O,h){O||(O=Date.now().toString());
const w=V.channel?.offlineChannelData,y={id:g.pq(V.videoId,"ytMainChannelEntity"),channelId:w.channelId,title:w.title,avatar:w.thumbnail},L={key:g.pq(V.videoId,"mainVideoDownloadStateEntity"),playbackData:g.pq(V.videoId,"playbackData"),addedTimestampMillis:O,videoDownloadContextEntity:g.pq(V.videoId,"videoDownloadContextEntity")},J={key:g.pq(V.videoId,"videoPlaybackPositionEntity"),videoId:V.videoId,lastPlaybackPositionSeconds:"0"};let C;m.W.Y("html5_offline_playback_position_sync")&&(C={playbackPosition:J.key});
O=g.pq(V.videoId,"mainVideoEntity");const E={key:O,videoId:V.videoId,title:V.title,thumbnail:V.thumbnail,localizedStrings:{viewCount:V.shortViewCountText},userState:C,lengthSeconds:V.lengthSeconds?Number(V.lengthSeconds):void 0,publishedTimestampMillis:V.publishedTimestamp?(Number(V.publishedTimestamp)*1E3).toString():void 0,formattedDescription:V.description,owner:y.id,downloadState:L.key};let q,M;m.W.Y("woffle_enable_main_downloads_library")&&h&&(h=await yUZ(m.Z,[O]))&&(q=h.mainDownloadsLibraryEntity,
M=h.mainDownloadsListEntity);let f;f={key:g.pq(V.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.bE(L,BV$,f);await b$(m.Z,{mode:"readwrite",tj:!0},x=>{var U=rx(x,y,"ytMainChannelEntity"),H=rx(x,L,"mainVideoDownloadStateEntity");const k=rx(x,E,"mainVideoEntity");U=[U,H,k];m.W.Y("html5_offline_playback_position_sync")&&(H=rx(x,J,"videoPlaybackPositionEntity"),U.push(H));q&&(H=rx(x,q,"mainDownloadsLibraryEntity"),U.push(H));M&&(H=rx(x,M,"mainDownloadsListEntity"),U.push(H));
f&&(x=rx(x,f,"downloadStatusEntity"),U.push(x));return g.IH.all(U)});
return{mainVideoEntity:E,channelEntity:y}},m_G=async function(m,V){const O=my(V),h=[];
var w=await nV.getInstance();let y,L;w&&(y=await w.get("sdois"),L=await w?.get("lmqf"));try{if(y===void 0)throw Error("prefStorage or opt-in state is undefined");w=[];y||(w=await wS$(m.Z),w.reverse());if(w.length)for(const E of w){if(!E)continue;const q=g.GQ(E).entityId,M=await KV(m.Z,q);M.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await o7(q,m.Z,{entityKey:E,actionType:V.actionType},m.L,M)}const J=await gd5(y,L??"SD");await Vqn(J);const C=h6z(J);m.W.Y("woffle_enable_main_downloads_library")&&
(y||await to(m.Z,g.sH),await dE(m.Z,[g.sH]));if(C?.length)for(const E of C){const q=E.actionType,M=E.entityKey,f=E.actionMetadata;if(q&&M&&f&&!g.T(f,P9$)){q==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(f.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const x=g.T(E.actionMetadata,PJ);x&&(x.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",E.actionMetadata={...E.actionMetadata,mainVideoEntityActionMetadata:x});h.push(E)}}}catch(J){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",J instanceof g.DB&&J.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,m,V)}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,h)},VuZ=async function(m,V=43200,O=!0){if(!m.N.vj())return[];
let h=[];try{h=await R6z(V,O,!1)}catch(w){w instanceof Error&&w.message==="No data"||w instanceof Error&&w.message==="Empty response body"&&B$(w.message)}return nwc(m,h,O,"mainPlaylistEntity")},O6z=async function(m,V,O,h=!1){let w=[];
if(!await odH()&&!h)return[];O=await AUI(V,O);if(!O?.length)return[];V={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const L of O){O=L.actionType;var y=L.entityKey;h=L.actionMetadata;O&&y&&h&&!g.T(h,P9$)&&(O==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(h.offlineLoggingData=V),{entityId:y}=g.GQ(y),O=await lG(m,[y],"mainVideoEntity",O,h),w=w.concat(O))}return w},wGM=async function(m,V){const O=my(V);
var h=g.GQ(V.entityKey).entityId;let w=[];try{w=await h1z(m,h),w?.length&&await TH(m.Z,V.entityKey)}catch(L){return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.DB&&L.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,V,h)}const y=[];w=await Jo(m.Z,"musicTrack",w);if(w.length)for(const L of w)m=
L.offlineVideoData,m?.videoId&&y.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m.videoId,"musicTrack",Number(V.actionMetadata?.priority||0)+1,mC,Y2(V,m,h)));return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,y)},yEI=async function(m,V){const O=my(V);
var h=V.entityKey,w=g.GQ(h).entityId,y=[],L=!1;w==="!*$_ALL_ENTITIES_!*$"?(L=!0,y=await eA(m.Z,"musicAlbumRelease")):(h=await I9(m.Z,h,"musicAlbumRelease"))&&y.push(h);if(!y?.length)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);if(L){V=[];for(var J of y){var C=g.GQ(J.id).entityId;V.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",C,"musicAlbumRelease",0,mC))}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,V)}J=[];y=y[0];L=void 0;y.downloadMetadata&&(L=await I9(m.Z,
y.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),L=Number(L?.addedTimestampMillis??"0")/1E3);try{J=await h1z(m,w,L?.toString())}catch(M){if(M instanceof Error&&M.message==="No data")await Xc(w,"musicAlbumRelease",m.Z,V,m.L);else if(M instanceof Error&&M.message==="Empty response body")B$(M.message);else return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",M instanceof g.DB&&M.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,V,C)}m=[];w=new Map;if(J?.length)for(var E of J)J=E.offlineVideoData,J?.videoId&&w.set(J.videoId,J);E=new Map;J=[];if(y?.tracks?.length)for(var q of y.tracks)if(y=g.GQ(q).entityId)w.has(y)?(E.set(y,w.get(y)),w.delete(y)):J.push(y);q=Number(V.actionMetadata?.priority||0)+1;for(const [M,f]of w.entries())m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",M,"musicTrack",q,mC,Y2(V,f)));for(const [M,
f]of E.entries())m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",M,"musicTrack",q,mC,Y2(V,f)));for(C of J)m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",C,"musicTrack",0,mC));return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,m)},jqH=async function(m,V){const O=my(V);
try{const h=g.GQ(V.entityKey).entityId;h==="!*$_ALL_ENTITIES_!*$"?await HJ(m.Z,V,m.L):(await Xc(h,"musicAlbumRelease",m.Z,V,m.L),await $2(m.Z,V.entityKey))}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},h1z=async function(m,V,O){V=await rE([V]);
m=await L5a(m,V[0],O);m=LV(m.thumbnailDetails);await R7(m);return V[0].videos},L5a=async function(m,V,O){var h=V.additionalMetadadatas;
let w=void 0;if(h&&h.length>0)for(var y of h)if(y.offlineMusicPlaylistData){w=y.offlineMusicPlaylistData;break}h=V.playlistId;const {DC:L,Lt:J}=EdG(V);O=O?(Number(O)*1E3).toString():Date.now().toString();y=V.lastModifiedTimestamp?(Number(V.lastModifiedTimestamp)*1E3).toString():"0";const C={id:g.pq(h,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:J,lastModifiedTimestampMillis:y,addedTimestampMillis:O,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},E={id:g.pq(h,"musicAlbumRelease"),
title:V.title,audioPlaylistId:h,trackCount:V.totalVideoCount,tracks:L,downloadMetadata:C.id};w&&(E.thumbnailDetails=w.albumHqThumbnail??w.albumArtistThumbnail,E.artistDisplayName=w.albumArtistDisplayName,E.releaseDate=w.albumReleaseDate,E.contentRating={explicitType:w.albumReleaseExplicitType},E.releaseType=w.albumReleaseType);await b$(m.Z,{mode:"readwrite",tj:!0},q=>{const M=rx(q,E,"musicAlbumRelease");q=rx(q,C,"musicAlbumReleaseDownloadMetadataEntity");return g.IH.all([M,q])});
return E},CRG=async function(m,V){const O=my(V);
var h=g.GQ(V.entityKey).entityId;let w=[];try{w=await JEZ(m,h),w?.length&&await TH(m.Z,V.entityKey)}catch(L){return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.DB&&L.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,V,h)}const y=[];w=await Jo(m.Z,"musicTrack",w);if(w.length)for(const L of w)m=
L.offlineVideoData,m?.videoId&&y.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m.videoId,"musicTrack",Number(V.actionMetadata?.priority||0)+1,VP,Y2(V,m,h)));return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,y)},ETW=async function(m,V){const O=my(V);
var h=V.entityKey,w=g.GQ(h).entityId,y=[],L=!1;w==="!*$_ALL_ENTITIES_!*$"?(L=!0,y=await eA(m.Z,"musicPlaylist")):(h=await I9(m.Z,h,"musicPlaylist"))&&y.push(h);if(!y?.length)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);const J=g.T(V.actionMetadata,qvA)?.autoSync;let C=[],E=!0;h=!0;let q=!1;var M=void 0;if(L||J!==!1){try{C=await UcG(0,!!J,!0,y)}catch(k){k instanceof Error&&k.message==="No data"?w==="!*$_ALL_ENTITIES_!*$"?await HJ(m.Z,V,m.L):await Xc(w,"musicPlaylist",m.Z,V,m.L):k instanceof
Error&&k.message==="Empty response body"&&B$(k.message)}if(!C.length||!L&&C[0].playlistId!==w)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)}if(L){V=[];for(var f of C)f.upToDate||J&&!f.shouldAutoSyncMetadata||!f.playlistId||V.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",f.playlistId,"musicPlaylist",0,VP,{musicPlaylistEntityActionMetadata:{autoSync:J}}));return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,V)}C.length&&(f=C[0],q=!!f.upToDate,J&&(E=f.shouldAutoSyncMetadata??
!0,h=f.shouldAutoSyncVideos??!0,f.checkInSeconds&&(M=f.checkInSeconds)));if(q||!E)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);f=[];y=y[0];L=void 0;y.downloadMetadata&&(L=await I9(m.Z,y.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),L=Number(L?.addedTimestampMillis??"0")/1E3);try{f=await JEZ(m,w,L?.toString(),M)}catch(k){if(k instanceof Error&&k.message==="No data")await Xc(w,"musicPlaylist",m.Z,V,m.L);else if(k instanceof Error&&k.message==="Empty response body")B$(k.message);
else{V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var x="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";k instanceof g.DB&&k.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",x="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,V,x)}}if(!h)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);m=[];w=new Map;if(f?.length)for(var U of f)h=U.offlineVideoData,h?.videoId&&
w.set(h.videoId,h);U=new Map;h=[];if(y?.tracks?.length)for(var H of y.tracks)if(M=g.GQ(H).entityId)w.has(M)?(U.set(M,w.get(M)),w.delete(M)):h.push(M);H=Number(V.actionMetadata?.priority||0)+1;for(const [k,b]of w.entries())m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k,"musicTrack",H,VP,Y2(V,b)));for(const [k,b]of U.entries())m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",k,"musicTrack",H,VP,Y2(V,b)));for(x of h)m.push(cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",x,"musicTrack",0,VP));
return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,m)},q9M=async function(m,V){const O=my(V);
try{const h=g.GQ(V.entityKey).entityId;h==="!*$_ALL_ENTITIES_!*$"?await HJ(m.Z,V,m.L):(await Xc(h,"musicPlaylist",m.Z,V,m.L),await $2(m.Z,V.entityKey))}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},JEZ=async function(m,V,O,h){V=await rE([V]);
m=await MuA(m,V[0],O,h);m=LV(m.thumbnailDetails);await R7(m);return V[0].videos},MuA=async function(m,V,O,h){const w=V.playlistId,{DC:y,
Lt:L}=EdG(V);O=O?(Number(O)*1E3).toString():Date.now().toString();const J=V.lastModifiedTimestamp?(Number(V.lastModifiedTimestamp)*1E3).toString():"0",C={id:g.pq(w,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:L,lastModifiedTimestampMillis:J,addedTimestampMillis:O,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},E={id:g.pq(w,"musicPlaylist"),title:V.title,playlistId:w,thumbnailDetails:V.thumbnail,visibility:fVn(V),trackCount:V.totalVideoCount,tracks:y,downloadMetadata:C.id};h&&(E?.entityMetadata?
E.entityMetadata.nextAutoRefreshIntervalSeconds=String(h):E&&(E.entityMetadata={nextAutoRefreshIntervalSeconds:String(h)}));await b$(m.Z,{mode:"readwrite",tj:!0},q=>{const M=rx(q,E,"musicPlaylist");q=rx(q,C,"musicPlaylistDownloadMetadataEntity");return g.IH.all([M,q])});
return E},fVn=function(m){switch(m.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},oTW=async function(m,V){const O=my(V);
var h=g.GQ(V.entityKey).entityId;const w=g.T(V.actionMetadata,OI);try{await x_A(m,h,void 0,w?.track,w?.albumRelease),w?.playlistId||await TH(m.Z,V.entityKey)}catch(y){return V="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.DB&&y.type==="QUOTA_EXCEEDED"&&(V="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,
void 0,V,h)}m=(m=g.T(V.actionMetadata,OI))?{playbackDataActionMetadata:{maximumDownloadQuality:m.maximumDownloadQuality}}:void 0;V=cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",h,"playbackData",Number(V.actionMetadata?.priority||0)+1,R1H,m);return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,[V])},gTA=async function(m,V){const O=my(V),h=g.GQ(V.entityKey).entityId;
var w=await I9(m.Z,V.entityKey,"musicTrack");const y=w?await I9(m.Z,w.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!w||!y)return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O);let L;w=g.T(V.actionMetadata,OI);try{await x_A(m,h,y.addedTimestampMillis,w?.track,w?.albumRelease),L=cJ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",h,"playbackData",Number(V.actionMetadata?.priority||0)+1,R1H)}catch(J){if(J instanceof Error&&J.message==="No data")await WJ(h,m.Z,V,m.L);else if(J instanceof
Error&&J.message==="Empty response body")B$(J.message);else return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",J instanceof g.DB&&J.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",V="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,m,V)}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O,L?[L]:void 0)},AEA=async function(m,
V){const O=my(V);
try{const h=g.GQ(V.entityKey).entityId;h==="!*$_ALL_ENTITIES_!*$"?await HJ(m.Z,V,m.L):(await WJ(h,m.Z,V,m.L),await $2(m.Z,V.entityKey))}catch(h){return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",O,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new bG("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",O)},x_A=async function(m,V,O,h,w){h||(h=(await f2W([V]))[0],h=CrZ(h));
const {musicTrackEntity:y,NS:L}=await U_z(m,h,V,w,O);m=LV(y.thumbnailDetails);V=[];L&&(V=LV(L.thumbnailDetails));await R7(m.concat(V))},U_z=async function(m,V,O,h,w){w||(w=Date.now().toString());
const y={id:g.pq(O,"musicTrackDownloadMetadataEntity"),playbackData:g.pq(O,"playbackData"),addedTimestampMillis:w,videoDownloadContextEntity:g.pq(O,"videoDownloadContextEntity")};h&&(V.albumRelease=h.id);await b$(m.Z,{mode:"readwrite",tj:!0},L=>{const J=[];var C=rx(L,y,"musicTrackDownloadMetadataEntity");J.push(C);C=rx(L,V,"musicTrack");J.push(C);h&&(L=rx(L,h,"musicAlbumRelease"),J.push(L));return g.IH.all(J)});
await wE(O,"musicTrackDownloadMetadataEntity",m.Z,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:V,NS:h}},d_n=async function(m,V=43200,O=!0){if(!m.N.vj())return[];
let h=[];try{h=await UcG(V,O,!1)}catch(w){}return nwc(m,h,O,"musicPlaylist")},tuM=function(m){let V;
m=g.T(m.getWatchNextResponse()?.currentVideoEndpoint,g.iq);m?.playlistId&&(V=m.playlistId);return V},K5$=async function(m,V){const O=V.clientPlaybackNonce,h={cpn:O,
offlineSourceVisualElement:g.oR(V.Qt||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};V.A&&(h.videoFmt=Number(V.A.itag));V.D&&(h.audioFmt=Number(V.D.itag));const w=tuM(V);var y;if(y=w&&V.videoId)V=V.videoId,y=await (w!=="PPSV"?Promise.resolve(!1):m.Z.Ae(V));y&&(h.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");m.A=O;g.xW("offlinePlaybackStarted",h)};
g.QV.prototype.S4=g.D1(42,function(m){return this.app.S4(m)});
g.SQ.prototype.S4=g.D1(41,function(m){return g.RLo(this,9,m)});
var hy=class{constructor(m){this.Z=m}},wf=class extends hy{get entityMetadata(){return this.Z.entityMetadata}set entityMetadata(m){this.Z.entityMetadata=m}},W5M=class extends hy{A(){const m=[];this.Z.video&&m.push(this.Z.video);return[...(new Set(m))]}},XG$=class extends hy{A(){const m=[];this.Z.video&&m.push(this.Z.video);this.Z.playlist&&m.push(this.Z.playlist);this.Z.videoItem&&m.push(this.Z.videoItem);this.Z.playlistItem&&m.push(this.Z.playlistItem);return[...(new Set(m))]}},H65=class extends hy{A(){const m=
[];this.Z.localImageEntities&&m.push(...this.Z.localImageEntities);this.Z.videoDownloadContextEntity&&m.push(this.Z.videoDownloadContextEntity);return[...(new Set(m))]}},TP$=class extends hy{A(){const m=[];this.Z.recommendedVideoMetadata&&m.push(...(new H65(this.Z.recommendedVideoMetadata)).A());return[...(new Set(m))]}},$_n=class extends hy{A(){const m=[];this.Z.playbackPosition&&m.push(this.Z.playbackPosition);return[...(new Set(m))]}},Y9a=class extends hy{A(){const m=[];this.Z.creatorEntity&&m.push(this.Z.creatorEntity);
return[...(new Set(m))]}},dc5=["browse","music/browse","streaming_browse","unplugged/browse"],H45=["offline/playlist_sync_check"],Mqn=["offline"],tq5=["offline/offline_video_playback_position_sync"],WRz=["offline/get_playback_data_entity"],dx,nV=class{constructor(m){this.token=m}static async getInstance(){return new Promise(m=>{g.CD().then(V=>{V?(nV.instance||(nV.instance=new nV(V)),m(nV.instance)):m(void 0)})})}async get(m){if(m=await (await td(this.token)).get("prefs",m)){var V=(0,g.Z)();
return m.expirationTimestampMs<=V?void 0:m.value}}async set(m,V,O=31536E3){const h=(0,g.Z)();m={key:m,value:V,expirationTimestampMs:h+O*1E3};V=await td(this.token);await g.pM(V,"prefs",m)}async remove(m){await (await td(this.token)).delete("prefs",m)}},kUG={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
KW=class extends g.Xa{constructor(m,V={}){super(kUG[m],{name:"PESEncoderError",type:m,...V});this.type=m;this.level="WARNING";Object.setPrototypeOf(this,KW.prototype)}},rEa=class{},cEc=class extends rEa{constructor(m){super();this.Z=m}L(m,V){V=W$(V);m=(new TextEncoder).encode(JSON.stringify(m));return this.Z.encrypt(m,V)}A(m,V){if(!(m instanceof Uint8Array))throw new KW("WRONG_DATA_TYPE",{Bb:1});const O=new TextDecoder;V=W$(V);m=this.Z.decrypt(m,V);return JSON.parse(O.decode(m))}},wNI={accountLinkStatusEntity:class extends wf{A(){return[]}},
booleanEntity:class extends wf{A(){return[]}},buttonEntity:class extends wf{A(){return[]}},captionTrack:class extends wf{A(){return[]}},channelHandle:class extends wf{A(){return[]}},chipEntity:class extends wf{A(){return[]}},commerceAcquisitionClientPayloadEntity:class extends wf{A(){return[]}},commerceCartListEntity:class extends wf{A(){return[]}},compositeSourceEntity:class extends wf{A(){return[]}},multiviewStagingEntity:class extends wf{A(){const m=[];this.Z.compositeSourceKeys&&m.push(...this.Z.compositeSourceKeys);
return[...(new Set(m))]}},contextNoteFeedEntityPayload:class extends wf{A(){return[]}},contextNoteUserRatingEntityPayload:class extends wf{A(){return[]}},continuationTokenEntity:class extends wf{A(){return[]}},downloadQualityPickerEntity:class extends wf{A(){return[]}},downloadsPageRefreshTokenEntity:class extends wf{A(){return[]}},downloadsPageViewConfigurationEntity:class extends wf{A(){return[]}},downloadStatusEntity:class extends wf{A(){return[]}},dismissState:class extends wf{A(){return[]}},
sfvAudioItemCurrentlyPlayingEntity:class extends wf{A(){return[]}},emojiFountainDataEntity:class extends wf{A(){return[]}},emojiCustomizationSetEntity:class extends wf{A(){return[]}},fakeChannel:class extends wf{A(){const m=[];this.Z.alternateChannel&&m.push(this.Z.alternateChannel);this.Z.alternateChannelList&&m.push(...this.Z.alternateChannelList);this.Z.oneofChannelEntity&&m.push(this.Z.oneofChannelEntity);return[...(new Set(m))]}},fakePlaylist:class extends wf{A(){const m=[];this.Z.entryCollection&&
m.push(this.Z.entryCollection);return[...(new Set(m))]}},fakePlaylistEntryCollection:class extends wf{A(){const m=[];this.Z.parentPlaylist&&m.push(this.Z.parentPlaylist);if(this.Z.entries)for(const V of this.Z.entries)m.push(...(new W5M(V)).A());return[...(new Set(m))]}},fakeVideo:class extends wf{A(){const m=[];this.Z.descriptionEntity&&m.push(this.Z.descriptionEntity);this.Z.creators&&m.push(...this.Z.creators);this.Z.theBiggestFan&&m.push(this.Z.theBiggestFan);return[...(new Set(m))]}},fakeVideoDescription:class extends wf{A(){return[]}},
featuredProductsEntity:class extends wf{A(){return[]}},flowStateEntity:class extends wf{A(){return[]}},iconBadgeEntity:class extends wf{A(){return[]}},interstitialInteractionStateEntity:class extends wf{A(){return[]}},likeButtonAnimationEntity:class extends wf{A(){return[]}},liveChatPollStateEntity:class extends wf{A(){return[]}},dataFreshnessEntity:class extends wf{A(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends wf{A(){return[]}},liveViewerLeaderboardPointsEntity:class extends wf{A(){return[]}},
liveReactionsDataEntity:class extends wf{A(){return[]}},logoEntity:class extends wf{A(){return[]}},macroMarkerEntity:class extends wf{A(){return[]}},mainDownloadsLibraryEntity:class extends wf{A(){const m=[];this.Z.downloadsList&&m.push(this.Z.downloadsList);this.Z.smartDownloadsList&&m.push(this.Z.smartDownloadsList);this.Z.recommendedDownloadsList&&m.push(this.Z.recommendedDownloadsList);this.Z.refresh&&m.push(this.Z.refresh);return[...(new Set(m))]}},mainDownloadsListEntity:class extends wf{A(){const m=
[];this.Z.refresh&&m.push(this.Z.refresh);if(this.Z.downloads)for(const V of this.Z.downloads)m.push(...(new XG$(V)).A());return[...(new Set(m))]}},mainPlaylistDownloadStateEntity:class extends wf{A(){const m=[];this.Z.localImageEntities&&m.push(...this.Z.localImageEntities);return[...(new Set(m))]}},mainPlaylistEntity:class extends wf{A(){const m=[];this.Z.channelOwner&&m.push(this.Z.channelOwner);this.Z.videos&&m.push(...this.Z.videos);this.Z.collaboratorChannels&&m.push(...this.Z.collaboratorChannels);
this.Z.downloadState&&m.push(this.Z.downloadState);this.Z.refresh&&m.push(this.Z.refresh);return[...(new Set(m))]}},mainPlaylistVideoEntity:class extends wf{A(){const m=[];this.Z.video&&m.push(this.Z.video);this.Z.channelContributor&&m.push(this.Z.channelContributor);return[...(new Set(m))]}},mainVideoDownloadStateEntity:class extends wf{A(){const m=[];this.Z.playbackData&&m.push(this.Z.playbackData);this.Z.localImageEntities&&m.push(...this.Z.localImageEntities);this.Z.videoDownloadContextEntity&&
m.push(this.Z.videoDownloadContextEntity);return[...(new Set(m))]}},mainVideoEntity:class extends wf{A(){const m=[];this.Z.owner&&m.push(this.Z.owner);this.Z.downloadState&&m.push(this.Z.downloadState);this.Z.userState&&m.push(...(new $_n(this.Z.userState)).A());this.Z.additionalMetadata&&m.push(...(new TP$(this.Z.additionalMetadata)).A());return[...(new Set(m))]}},markersEngagementPanelSyncEntity:class extends wf{A(){return[]}},markersVisibilityOverrideEntity:class extends wf{A(){return[]}},musicAlbumReleaseDetail:class extends wf{A(){const m=
[];this.Z.albumRelease&&m.push(this.Z.albumRelease);this.Z.tracks&&m.push(...this.Z.tracks);return[...(new Set(m))]}},musicAlbumReleaseDownloadMetadataEntity:class extends wf{A(){const m=[];this.Z.trackDownloadMetadatas&&m.push(...this.Z.trackDownloadMetadatas);return[...(new Set(m))]}},musicAlbumRelease:class extends wf{A(){const m=[];this.Z.musicLibraryStatusEntity&&m.push(this.Z.musicLibraryStatusEntity);this.Z.primaryArtists&&m.push(...this.Z.primaryArtists);this.Z.details&&m.push(this.Z.details);
this.Z.userDetails&&m.push(this.Z.userDetails);this.Z.tracks&&m.push(...this.Z.tracks);this.Z.share&&m.push(this.Z.share);this.Z.downloadMetadata&&m.push(this.Z.downloadMetadata);this.Z.refresh&&m.push(this.Z.refresh);return[...(new Set(m))]}},musicAlbumReleaseUserDetail:class extends wf{A(){const m=[];this.Z.albumRelease&&m.push(this.Z.albumRelease);return[...(new Set(m))]}},musicArtistDetail:class extends wf{A(){const m=[];this.Z.parentArtist&&m.push(this.Z.parentArtist);return[...(new Set(m))]}},
musicArtist:class extends wf{A(){const m=[];this.Z.details&&m.push(this.Z.details);this.Z.userDetails&&m.push(this.Z.userDetails);return[...(new Set(m))]}},musicArtistUserDetail:class extends wf{A(){const m=[];this.Z.parentArtist&&m.push(this.Z.parentArtist);return[...(new Set(m))]}},musicDownloadsLibraryEntity:class extends wf{A(){const m=[];this.Z.downloadedTracks&&m.push(...this.Z.downloadedTracks);this.Z.smartDownloadedTracks&&m.push(...this.Z.smartDownloadedTracks);this.Z.downloadedEpisodes&&
m.push(...this.Z.downloadedEpisodes);this.Z.downloadedAlbumReleases&&m.push(...this.Z.downloadedAlbumReleases);this.Z.smartDownloadedAlbumReleases&&m.push(...this.Z.smartDownloadedAlbumReleases);this.Z.downloadedPlaylists&&m.push(...this.Z.downloadedPlaylists);this.Z.smartDownloadedPlaylists&&m.push(...this.Z.smartDownloadedPlaylists);this.Z.metadataOnlyTracks&&m.push(...this.Z.metadataOnlyTracks);return[...(new Set(m))]}},musicLibraryEdit:class extends wf{A(){return[]}},musicLibraryStatusEntity:class extends wf{A(){return[]}},
musicPlaylist:class extends wf{A(){const m=[];this.Z.tracks&&m.push(...this.Z.tracks);this.Z.refresh&&m.push(this.Z.refresh);this.Z.musicLibraryStatusEntity&&m.push(this.Z.musicLibraryStatusEntity);this.Z.details&&m.push(this.Z.details);this.Z.downloadMetadata&&m.push(this.Z.downloadMetadata);this.Z.sideloadMetadata&&m.push(this.Z.sideloadMetadata);this.Z.userDetails&&m.push(this.Z.userDetails);this.Z.entryCollection&&m.push(this.Z.entryCollection);this.Z.share&&m.push(this.Z.share);this.Z.podcastShowAdditionalMetadata&&
m.push(...(new Y9a(this.Z.podcastShowAdditionalMetadata)).A());return[...(new Set(m))]}},musicPlaylistDownloadMetadataEntity:class extends wf{A(){const m=[];this.Z.trackDownloadMetadatas&&m.push(...this.Z.trackDownloadMetadatas);return[...(new Set(m))]}},musicShare:class extends wf{A(){return[]}},musicTrackDetail:class extends wf{A(){const m=[];this.Z.parentTrack&&m.push(this.Z.parentTrack);return[...(new Set(m))]}},musicTrackDownloadMetadataEntity:class extends wf{A(){const m=[];this.Z.playbackData&&
m.push(this.Z.playbackData);this.Z.localImageEntities&&m.push(...this.Z.localImageEntities);this.Z.videoDownloadContextEntity&&m.push(this.Z.videoDownloadContextEntity);return[...(new Set(m))]}},musicTrack:class extends wf{A(){const m=[];this.Z.musicLibraryStatusEntity&&m.push(this.Z.musicLibraryStatusEntity);this.Z.artists&&m.push(...this.Z.artists);this.Z.audioModeVersion&&m.push(this.Z.audioModeVersion);this.Z.videoModeVersion&&m.push(this.Z.videoModeVersion);this.Z.userDetails&&m.push(this.Z.userDetails);
this.Z.details&&m.push(this.Z.details);this.Z.albumRelease&&m.push(this.Z.albumRelease);this.Z.share&&m.push(this.Z.share);this.Z.libraryEdit&&m.push(this.Z.libraryEdit);this.Z.downloadMetadata&&m.push(this.Z.downloadMetadata);this.Z.playbackPosition&&m.push(this.Z.playbackPosition);this.Z.lyrics&&m.push(this.Z.lyrics);return[...(new Set(m))]}},musicTrackUserDetail:class extends wf{A(){const m=[];this.Z.parentTrack&&m.push(this.Z.parentTrack);return[...(new Set(m))]}},offlineOrchestrationActionWrapperEntity:class extends wf{A(){return[]}},
offlineVideoPolicy:class extends wf{A(){return[]}},offlineVideoStreams:class extends wf{A(){return[]}},offlineabilityEntity:class extends wf{A(){return[]}},orchestrationWebSamplingEntity:class extends wf{A(){const m=[];this.Z.fakeChildren&&m.push(...this.Z.fakeChildren);return[...(new Set(m))]}},pageHeaderEntity:class extends wf{A(){return[]}},pdpStateEntity:class extends wf{A(){return[]}},pinnedProductEntity:class extends wf{A(){return[]}},playbackData:class extends wf{A(){const m=[];this.Z.transfer&&
m.push(this.Z.transfer);this.Z.adsPlaybackData&&m.push(...this.Z.adsPlaybackData);this.Z.drmLicense&&m.push(this.Z.drmLicense);this.Z.offlineVideoPolicy&&m.push(this.Z.offlineVideoPolicy);this.Z.videoDownloadContextEntity&&m.push(this.Z.videoDownloadContextEntity);return[...(new Set(m))]}},playerStateEntity:class extends wf{A(){return[]}},quantityIncrementerEntity:class extends wf{A(){return[]}},refresh:class extends wf{A(){return[]}},saveToPlaylistListEntity:class extends wf{A(){return[]}},selectedChipIndexEntityPayload:class extends wf{A(){return[]}},
settingEntity:class extends wf{A(){return[]}},stringEntity:class extends wf{A(){return[]}},suggestedFeedbackChipStateEntity:class extends wf{A(){return[]}},transfer:class extends wf{A(){const m=[];this.Z.offlineVideoStreams&&m.push(...this.Z.offlineVideoStreams);this.Z.captionTrack&&m.push(...this.Z.captionTrack);return[...(new Set(m))]}},trendingOfferEntity:class extends wf{A(){return[]}},videoDownloadContextEntity:class extends wf{A(){return[]}},videoOverviewAsyncDataEntity:class extends wf{A(){return[]}},
videoPlaybackPositionEntity:class extends wf{A(){return[]}},votingEntity:class extends wf{A(){return[]}},ytMainChannelEntity:class extends wf{A(){const m=[];this.Z.userChannelDetails&&m.push(this.Z.userChannelDetails);return[...(new Set(m))]}},youchatPendingResponseEntity:class extends wf{A(){return[]}},ytMainDownloadedVideoEntity:class extends wf{A(){const m=[];this.Z.video&&m.push(this.Z.video);this.Z.playbackData&&m.push(this.Z.playbackData);this.Z.offlineVideoPolicy&&m.push(this.Z.offlineVideoPolicy);
return[...(new Set(m))]}},ytMainVideoEntity:class extends wf{A(){const m=[];this.Z.channelOwner&&m.push(this.Z.channelOwner);this.Z.playbackPosition&&m.push(this.Z.playbackPosition);this.Z.localImageEntities&&m.push(...this.Z.localImageEntities);this.Z.downloadStatus&&m.push(this.Z.downloadStatus);return[...(new Set(m))]}}},MtM=class{constructor(m,V){this.Z=m;this.A=V;this.L={}}},D_J=class extends rEa{L(m){return m}A(m){if(m instanceof Uint8Array)throw new KW("WRONG_DATA_TYPE",{Bb:0});return m}},
RwA=class{constructor(){this.Z={};this.Z[0]=new D_J;if(!g.FX("aes_pes_encoder_killswitch")){var m=this.Z;try{const h=g.x7();var V=W$(h);var O=new cEc(new g.DZ(V),new g.Tw(V))}catch(h){throw m=h instanceof Error?new KW("KEY_CREATION_FAILED",{originalMessage:h.message}):new KW("KEY_CREATION_FAILED"),g.a(m),m;}m[1]=O}}},oXh=class extends g.Ja{constructor(m,V){super();this.token=m;this.Z=V;this.observers=[];m=new g.aC.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.x7()}`);m.onmessage=this.A.bind(this);
this.channel=m}observe(m){this.observers.push(m);return()=>{const V=this.observers.indexOf(m);V>=0&&this.observers.splice(V,1)}}A(m){qVH(this,m.data)}d0(){this.channel.close()}},u$,O4A=new g.v("elementsCommand");var UT=new g.v("entityBatchUpdate");var BV$=new g.v("downloadStatusEntity");var ufn=new g.v("mainPlaylistEntityActionMetadata");var PJ=new g.v("mainVideoEntityActionMetadata");var qvA=new g.v("musicPlaylistEntityActionMetadata");var OI=new g.v("musicTrackEntityActionMetadata");var P9$=new g.v("localImageEntityActionMetadata");var Ds=new g.v("playbackDataActionMetadata");var a2I=new g.v("transferEntityActionMetadata");var b45=new g.v("videoPlaybackPositionEntityActionMetadata");var r9a=class{constructor(){this.Z=new Map}},sq;new g.xN;new g.xN;var nXA=class{constructor(){this.locks=navigator.locks}request(m,V={},O){return this.locks.request(m,V,h=>O(h))}};var i$=g.aC.caches,a9,G1,NPI=class{open(m){return i$.open(F5(m))}has(m){return i$.has(F5(m))}delete(m){return i$.delete(F5(m))}async match(m,V){var O=await this.keys();for(const h of O)if(O=await (await this.open(h)).match(m,V))return O}},ew5=class extends NPI{async keys(){const m=[],V=g.x7("CacheStorage keys");var O=await i$.keys();for(const h of O){O=h.indexOf(":");const {D5:w,datasyncId:y}=O===-1?{D5:h}:{D5:h.substring(0,O),datasyncId:h.substring(O+1)};y===V&&m.push(w)}return m}};var b6H=class extends g.Ja{constructor(m){super();this.api=m;this.nP={JYe:()=>this.Z,
l4t:()=>this.A};
typeof g.aC.BroadcastChannel!=="undefined"&&(this.Z=new g.aC.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.x7()}`),this.Z.onmessage=this.L.bind(this),this.A=new g.aC.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.x7()}`),this.A.onmessage=this.D.bind(this))}L(m){g.Zj(this.api,"onOfflineOperationFailure",m.data)}D(m){this.api.publish("offlinetransferpause",m.data)}d0(){this.Z?.close();this.A?.close()}};var nTJ=class{constructor(m,V,O){this.X=m;this.V=V;this.visibility=O;this.T=this.N=this.U=this.L=this.Z=!1;this.D=new g.Vf(()=>{this.Ws()});
this.nP={HH:()=>this.A,
Ws:()=>{this.Ws()},
myr:()=>this.D};
this.visibility.subscribe("visibilitystatechange",()=>{this.GB()})}GB(){this.Z&&Qr(this)}Ws(){this.A&&this.A.resolve();
this.L=this.Z=!1;this.V()}};var LxA=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var qk=class{constructor(m,V,O,h,w=V,y,L,J,C,E,q){this.entityType=m;this.actionId=V;this.action=O;this.parentActionId=h;this.rootActionId=w;this.childActionIds=y;this.prereqActionId=L;this.postreqActionIds=J;this.hasChildActionFailed=E;this.retryScheduleIndex=0;this.Z=q||Date.now();this.retryScheduleIndex=C||0}};var mcc="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var JUn="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var yP=class{constructor(m){this.Z=m}},bG=class{constructor(m,V,O,h,w,y){this.status=m;this.Z=V;this.D=O;this.A=h;this.L=w;this.downloadState=y}};var S9Z=class extends yP{constructor(m,V,O){super(m);this.Z=m;this.W=V;this.L=O}A(m){return VD(m)?kSW(this,m):OT(m)?DcM(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var IVJ=class extends yP{constructor(m,V){super(m);this.Z=m;this.W=V}A(m){return OT(m)?NyM(this,m):pN5(m)?ndn(this,m):ho(m)?SvH(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var e1A=class{constructor(m,V){this.api=m;this.Z=V;this.logger=new g.Ar("woffle");this.A=!1;this.nP={gR:this.gR}}async D(m){if(m.state.Z(128)){const V=m.state.fC;m=V?.errorCode;m=m==="net.connect"&&V?.Se===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":m?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.CS(this.player.getVideoData().videoId,m)}}async CS(m,V){this.A||(this.A=!0,V==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?eI(this,m,!1,!0):(await I7(this,m),
g.DW(m,4),await this.Z.CS(V)))}bx(m){m.status===2?(m.status!==this.L&&(pV(this.Z),g.DW(m.videoId,2)),m.Xi&&gw$(this.Z,m.videoId,m.Xi)):m.status===4?(I7(this,m.videoId),this.CS(m.videoId,m.d1?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):m.status===1&&U0H(this.Z);this.L=m.status;g.Zj(this.api,"localmediachange",{videoId:m.videoId,status:m.status})}async Yn(){if(!this.A){this.A=!0;var m=this.player.getVideoData().videoId;await I7(this,m);await this.Z.Yn()}}gR(m){switch(m){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}Y(m){return this.api.B().Y(m)}};var uA5=class extends yP{constructor(m,V){super(m);this.Z=m;this.W=V}A(m){return VD(m)?Z4z(this,m):OT(m)?ssA(this,m):pN5(m)?FRA(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var z15=class{constructor(){this.actions=[]}Z(m,V){let O=m.action.actionMetadata.priority-V.action.actionMetadata.priority;O===0&&(m.Z<V.Z?O=-1:m.Z>V.Z&&(O=1));return O}};var Qsa=class extends g.Ja{constructor(m,V,O,h,w){super();this.A=m;this.Qt=V;this.Zu=O;this.N=h;this.W=w;this.Z=new z15;this.U=new g.fB;this.L=new g.Vf(()=>{this.retry()});
this.X=NaN;this.T=!1;this.nP={c66:()=>this.Z,
q4:()=>this.U,
IeH:()=>this.L,
retry:()=>this.retry()};
g.D(this,this.L);this.V=this.A.observe(this.S.bind(this))}d0(){this.V&&this.V();super.d0()}createAction(m,V){const O=g.GQ(m.entityKey).entityType,h=g.Rl(16);return new qk(O,h,m,V.actionId,V.rootActionId)}async S(m){if(!this.EH()){var V=m.offlineOrchestrationActionWrapperEntity??new Set;m=[];for(var O of V)({entityId:V}=g.GQ(O)),l2W(this.Z,V)||m.push(O);O=await yzZ(this,m);await Zs(this,O)}}async retry(){await C9z(this)}};var Z6W=class{constructor(m){this.oY=m;this.Z=void 0}async DM(m,V=!0){if(this.Z){var O=[],h=g.BY(this.Z.Z,V),w=[];for(let y=0;y<h.length;y++)V=this.Z.U(h[y],"json3"),V=g.Oi(V,{withCredentials:!0,format:"RAW"},3,500).then(L=>{L={metadata:g.R_(h[y]),trackData:L.xhr.responseText};w.push(L)}).jm(L=>{B$("Caption fetch error",L)}),O.push(V);
await llc(O);try{await XNG(m,w)}catch(y){B$("Caption DB transaction error",y)}}}};var sq$=class extends g.Ja{constructor(m){super();this.Z=m;this.A=this.Z.observe(this.L.bind(this))}d0(){this.A&&this.A();super.d0()}async L(m){var V=m.transfer??new Set;m=[];for(const O of V)({entityId:V}=g.GQ(O)),m.push(V);m.length!==0&&await Mon(this,m)}};var czz=class extends g.Ja{constructor(m,V,O,h){super();this.A=m;this.api=V;this.H6=O;this.S=h;this.U=new g.fB;this.D=new g.Vf(()=>{this.Z&&this.Z.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.U.vj()&&((this.Z.transferRetryCount||0)<3?eI(this.N,this.T,!1,!1):I7(this.N,this.T.videoDetails.videoId),this.CS("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.Zu=this.mS=0;this.V=this.X=!1;this.YN=g.ea(this.api.B().experiments,"html5_transfer_processing_logs_interval");this.Te=new g.hf(this);this.nP={qZA:()=>this.D,
n5t:()=>this.S,
q4:()=>this.U};
this.Qt=this.A.observe(this.UH.bind(this));this.N=new e1A(V,this);this.Nf=new Z6W(V);this.Ae=new sq$(this.A);this.g0=this.U.listen("publicytnetworkstatus-online",this.Ce.bind(this));this.ze=this.U.listen("publicytnetworkstatus-offline",this.Mf.bind(this));this.V=this.api.B().Y("html5_less_transfer_processing_logs");g.D(this,this.Te);this.Te.O(V,"offlinetransferpause",this.Xr);if(g.vK(this.api.B()))this.L="mainVideoDownloadStateEntity";else if(g.Fo(this.api.B())||g.mt(this.api.B()))this.L="musicTrackDownloadMetadataEntity"}d0(){this.Qt&&
this.Qt();this.Ae.dispose();this.D.dispose();this.g0&&g.gq(this.U.Rf,this.g0);this.ze&&g.gq(this.U.Rf,this.ze);super.d0()}async Xr(m){const V=g.pq(m,"transfer");if(this.Z&&V===this.Z.key)eI(this.N,this.T,!0),this.D.stop();else{const O=await b$(this.A,{mode:"readwrite",tj:!0},h=>T1(h,V,"transfer").then(w=>{if(w&&w.transferState!=="TRANSFER_STATE_COMPLETE"&&w.transferState!=="TRANSFER_STATE_FAILED")return w.transferState="TRANSFER_STATE_PAUSED_BY_USER",rx(h,w,"transfer").then(()=>w)}));
if(O){m&&this.L&&await wE(m,this.L,this.A,"DOWNLOAD_STATE_PAUSED");const h=await Fc(this,m);ikH({videoId:m,Os:O,offlineModeType:h})}}}Mf(){if(this.Z&&this.T){eI(this.N,this.T,!1);const m=this.Z,V=m?.key?g.GQ(m.key).entityId:"";V&&this.L&&(new Promise((O,h)=>{wE(V,this.L,this.A,"DOWNLOAD_STATE_PAUSED").catch(w=>{h(w)})})).catch(O=>{B$("Download state setting error",O)})}this.D.stop()}Ce(){this.Z?TBz(this,this.Z):GH(this)}async UH(m){if(this.Z&&(this.Z.transferState!=="TRANSFER_STATE_COMPLETE"&&this.Z.transferState!==
"TRANSFER_STATE_FAILED"&&m.transfer&&m.transfer.has(this.Z.key)&&((this.Z=await I9(this.A,this.Z.key,"transfer"))||await $0Z(this)),this.Z))return;
await GH(this)}async CS(m,V){if(this.Z){var O=this.Z;const w=O?.key?g.GQ(O.key).entityId:"";a:switch(m){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var h=!1;break a;default:h=!0}h&&YAM(this)?(await sT(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),m=await Fc(this,w),P$({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:w,Os:O,offlineModeType:m}),
w&&this.L&&await wE(w,this.L,this.A,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await kjn(this,m),w&&this.L&&await wE(w,this.L,this.A,"DOWNLOAD_STATE_FAILED"))}else a7(this,`onTransferFailure: ${m}`);iG(this);O=GH(this,!0);V&&V(O)}async Yn(m){if(this.Z)if(YAM(this)){await sT(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.Z||a7(this,"onMaybeTransferStreamsExpiredRetryAttempting");var V=this.Z,O=V?.key?g.GQ(V.key).entityId:"",h=await Fc(this,O);P$({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:O,Os:V,offlineModeType:h});V=ET();g.bE(V,Ds,{isEnqueuedForExpiredStreamUrlRefetch:!0});h=g.pq(O,"playbackData");O=fV(new qk("playbackData",O,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:h,actionMetadata:V}));await nW(this.A,O,"offlineOrchestrationActionWrapperEntity")}else await kjn(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.L&&(O=this.Z,(O=O?.key?g.GQ(O.key).entityId:"")&&await wE(O,this.L,this.A,"DOWNLOAD_STATE_FAILED"));else a7(this,"onMaybeTransferStreamsExpired");
iG(this);O=GH(this,!0);m&&m(O)}},BJ={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var F5G=class{constructor(m,V){this.W=m;this.api=V;this.N=new g.fB;this.T=new g.xN;this.nP={HH:()=>this.L.nP.HH(),
q4:()=>this.N,
Slr:()=>this.L,
Gt:()=>this.Gt(),
Iy:()=>this.Iy(),
iD:()=>this.iD(),
JS:()=>this.JS(),
oR:()=>this.oR(),
PZ:O=>this.PZ(O)};
this.L=new nTJ(()=>rzJ(this),()=>{this.iD()},this.api.QW(),this.api.Y.bind(this.api));
this.Z=new b6H(this.api);zwn(this.L)}Gt(){return this.T.promise}Iy(){if(this.A&&this.X)return this.T.promise;NBh(this).then(this.T.resolve).catch(this.T.reject);return this.T.promise}U(m){return{playbackData:new S9Z(m,this.W,this.Z),transfer:new uA5(m,this.W),videoPlaybackPositionEntity:new IVJ(m,this.W)}}async JS(){this.A&&await d0Z(this.A)}async iD(){if(this.A||this.X)await this.Gt(),this.Zu!==void 0&&(g.Zt(this.Zu),this.Zu=void 0),this.D!==void 0&&(g.Zt(this.D),this.D=void 0),this.A?.dispose(),
this.A=void 0,this.X?.dispose(),this.X=void 0,g.Zj(this.api,"onOrchestrationLostLeader"),this.T=new g.xN}isOrchestrationLeader(){return this.L.Z}async Ae(){return!1}RR(m){var V=this.Z;V.api.publish("offlinetransferpause",m);V.A?.postMessage(m)}async Ce(m){const V=await z1();if(V){var O=g.pq(m,"transfer");await b$(V,{mode:"readwrite",tj:!0},h=>{const w=T1(h,O,"transfer"),y=T1(h,g.pq(m,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.IH.all([w,y]).then(([L,J])=>L&&L.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(L.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",rx(h,L,"transfer").then(()=>{P$({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:m,Os:L,offlineModeType:J?.offlineModeType});return g.IH.resolve(null)})):g.IH.resolve(null))})}}async Qt(m=43200){if(!this.N.vj())return bxa();
var V=await z1();if(!V)return[];const O=Date.now()/1E3;var h=await eA(V,"offlineVideoPolicy");V=[];for(const w of h)Number(w.lastUpdatedTimestampSeconds)+m<=O&&(h=g.GQ(w.key).entityId,V.push(h));return V.length?lG(this,V,this.S,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return lG(this,["!*$_ALL_ENTITIES_!*$"],this.S,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(m){return await this.Qt(m)}setUpPositionSyncInterval(m){this.D!==
void 0&&(g.Zt(this.D),this.D=void 0);const V=m??864E5;this.D=g.uC(()=>{this.PZ(V)},V)}async PZ(m){try{const V=await nV.getInstance();
if(!V)throw Error("prefStorage is undefined");const O=await V.get("psi"),h=O?.w1?Number(O.w1)/1E3:0,w=Date.now();h+m<=w&&await lG(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(V){B$("Offline manager error",V)}}async oR(){var m=await z1();if(!m)return[];var V=await eA(m,"transfer");m=[];for(const O of V)O.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&O.key&&(V=g.GQ(O.key).entityId,m.push(V));return SAM(this,m)}async V(){return[]}async ze(){}async mS(){}};var aVn=class extends yP{constructor(m,V,O){super(m);this.Z=m;this.W=V;this.L=O}A(m){return VD(m)?eDZ(this,m):OT(m)?zDH(this,m):ho(m)?ZxW(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},QD=[10];var i6h=class extends yP{constructor(m,V,O){super(m);this.Z=m;this.W=V;this.L=O}A(m){return VD(m)?BB5(this,m):OT(m)?lpI(this,m):ho(m)?Qy$(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},piH=[10];var GUM=class extends yP{constructor(m,V,O){super(m);this.Z=m;this.W=V;this.L=O}A(m){return OT(m)?m_G(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var pGM=class extends F5G{constructor(){super(...arguments);this.S="mainVideoEntity"}U(m){const V=super.U(m);V.mainVideoEntity=new i6h(m,this.W,this.Z);V.mainPlaylistEntity=new aVn(m,this.W,this.Z);V.mainDownloadsListEntity=new GUM(m,this.W,this.Z);return V}async refreshAllStaleEntities(m,V){let O=[];this.W.Y("web_player_offline_playlist_auto_refresh")&&(O=await VuZ(this,m,V));var h=await nV.getInstance();const w=await h?.get("sdois");h=await h?.get("lmqf");w&&(O=O.concat(await O6z(this,w,h??"SD",
m===0)));return O=O.concat(await super.refreshAllStaleEntities(m,V))}async Ae(m){var V=await z1();if(!V)return!1;V=await I9(V,g.sH,"mainDownloadsListEntity");if(V?.downloads?.length){m=g.pq(m,"mainVideoEntity");for(const O of V.downloads)if(O.videoItem===m)return!0}return!1}async V(){var m=await z1();if(!m)return[];var V=await eA(m,"downloadStatusEntity");m=[];for(const O of V)O.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&O.key&&(V=g.GQ(O.key).entityId,m.push(V));return m.length?lG(this,m,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async mS(){const m=await z1();m&&await b$(m,{mode:"readwrite",tj:!0},V=>$g(V,"mainVideoEntity").then(O=>{const h=[];for(const w of O)w.userState?.playbackPosition||(O=g.GQ(w.key).entityId,O={key:g.pq(O,"videoPlaybackPositionEntity"),videoId:O,lastPlaybackPositionSeconds:"0"},h.push(rx(V,O,"videoPlaybackPositionEntity")),w.userState={playbackPosition:O.key},h.push(rx(V,w,
"mainVideoEntity")));return g.IH.all(h)}))}async ze(){const m=await z1();
if(m){var V=g.pq("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),O=await b$(m,{mode:"readonly",tj:!0},M=>g.IH.all([T1(M,V,"mainDownloadsListEntity"),T1(M,g.sH,"mainDownloadsListEntity"),$g(M,"mainVideoEntity"),$g(M,"mainPlaylistEntity")])),[h,
w,y,L]=O;O=new Set;if(h?.downloads?.length)for(var J of h.downloads){var C=J.videoItem??J.playlistItem;C&&O.add(C)}if(w?.downloads?.length)for(var E of w.downloads)E.videoItem&&O.add(E.videoItem);J=new Set;E=[];for(var q of L){if(q.videos)for(const M of q.videos)(C=JSON.parse(g.GQ(M).entityId).videoId)&&J.add(C);q.key&&!O.has(q.key)&&E.push(q.key)}for(const M of y)M.key&&!O.has(M.key)&&(q=g.GQ(M.key).entityId,J.has(q)||E.push(M.key));E.length&&await dE(m,E)}}};var BPa=class extends yP{constructor(m,V){super(m);this.Z=m;this.L=V}A(m){return VD(m)?wGM(this,m):OT(m)?yEI(this,m):ho(m)?jqH(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},mC=[10];var lVJ=class extends yP{constructor(m,V){super(m);this.Z=m;this.L=V}A(m){return VD(m)?CRG(this,m):OT(m)?ETW(this,m):ho(m)?q9M(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},VP=[10];var Qqn=class extends yP{constructor(m,V){super(m);this.Z=m;this.L=V}A(m){return VD(m)?oTW(this,m):OT(m)?gTA(this,m):ho(m)?AEA(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},R1H=[10];var vTH=class extends F5G{constructor(){super(...arguments);this.S="musicTrack"}U(m){const V=super.U(m);V.musicTrack=new Qqn(m,this.Z);V.musicPlaylist=new lVJ(m,this.Z);V.musicAlbumRelease=new BPa(m,this.Z);return V}async refreshAllStaleEntities(m,V){let O=await d_n(this,m,V);return O=O.concat(await super.refreshAllStaleEntities(m,V))}};g.x3("offline",class extends g.dz{constructor(){super(...arguments);this.events=new g.hf(this);this.W=this.player.B();this.nP={WnH:()=>this.Z,
rA:()=>this.rA(),
SN:m=>this.SN(m)}}create(){g.D(this,this.events);
if(g.vK(this.W))this.Z=new pGM(this.W,this.player);else if(g.Fo(this.W)||g.mt(this.W))this.Z=new vTH(this.W,this.player);this.events.O(this.player,"onPlaybackStartExternal",()=>{this.rA()});
this.events.O(this.player,"videodatachange",()=>{this.rA()});
this.W.Y("html5_offline_playback_position_sync")&&this.events.O(this.player,"presentingplayerstatechange",this.SN)}Pm(){return!1}async BT(m,V,O,h){return this.Z?lG(this.Z,m,V,O,h):Promise.reject()}deleteAll(){return this.Z.deleteAll()}Qt(m){return this.Z.Qt(m)}refreshAllStaleEntities(m){return this.Z.refreshAllStaleEntities(m)}setUpPositionSyncInterval(m){this.Z.setUpPositionSyncInterval(m)}RR(m){this.Z.RR(m)}Ce(m){return this.Z.Ce(m)}async rA(){const m=this.player.getVideoData();m.HD()&&tuM(m)&&
this.A!==m.clientPlaybackNonce&&await K5$(this,m)}async SN(m){var V=this.player.getVideoData();const O=V.FA;if(m.Z4(2)||m.Z4(512))(m=await z1())?(V=V.videoId,await I9(m,g.pq(V,"mainVideoEntity"),"mainVideoEntity")&&await this.BT([V],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(O).toString()}})):B$("PES is undefined")}isOrchestrationLeader(){return this.Z.isOrchestrationLeader()}async updateDownloadState(m,
V){const O=await z1();if(O){var {entityType:h,entityId:w}=g.GQ(m);await wE(w,h,O,V,!0)}else B$("PES is undefined")}});})(_yt_player);
